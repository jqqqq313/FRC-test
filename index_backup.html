<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Fair Rent Commission Case Prep Tool</title>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
        color: white;
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.2em;
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .sidebar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .main-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .nav-btn {
        display: block;
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .nav-btn.active {
        background: linear-gradient(45deg, #764ba2, #667eea);
        transform: scale(1.05);
    }

    .section {
        display: none;
    }

    .section.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
    }

    input, textarea, select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #667eea;
    }

    textarea {
        resize: vertical;
        min-height: 100px;
    }

    .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .checklist {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .checklist-item {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .checklist-item input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
    }

    .progress-bar {
        background: #e0e0e0;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        transition: width 0.3s ease;
    }

    .alert {
        padding: 15px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        background: #e8f4ff;
    }

    .timeline {
        position: relative;
        margin: 20px 0;
    }

    .timeline-item {
        position: relative;
        padding: 20px;
        margin: 10px 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }

    .document-list {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .document-item {
        padding: 15px;
        margin: 10px 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-needed {
        background: #ffebee;
        color: #c62828;
    }

    .status-recommended {
        background: #fff3e0;
        color: #f57c00;
    }

    .status-optional {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-ready {
        background: #e8f5e8;
        color: #2e7d32;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .header h1 {
            font-size: 2em;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Connecticut Fair Rent Commission Case Prep Tool</h1>
            <p>Comprehensive case preparation for tenant rent disputes</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>FRC Case Builder</h3>
                <button class="nav-btn active" onclick="showSection('basics')">1. Case Information</button>
                <button class="nav-btn" onclick="showSection('financial')">2. Financial Impact</button>
                <button class="nav-btn" onclick="showSection('evidence')">3. Evidence & Timeline</button>
                <button class="nav-btn" onclick="showSection('market')">4. Market Analysis</button>
                <button class="nav-btn" onclick="showSection('filing')">5. Generate FRC Filing</button>
                <button class="nav-btn" onclick="showSection('resources')">6. Resources</button>
                
                <div style="margin-top: 30px;">
                    <h4>Filing Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="progressText">0% Complete</p>
                </div>
            </div>

            <div class="main-panel">
                <!-- Case Information Section -->
                <div id="basics" class="section active">
                    <h2>Case Information</h2>
                    <div class="alert">
                        <strong>Fair Rent Commission Filing:</strong> Provide basic case details that will be included in your official FRC submission.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label for="tenantName">Your Full Name</label>
                                <input type="text" id="tenantName" placeholder="Enter your full legal name">
                            </div>
                            
                            <div class="form-group">
                                <label for="propertyAddress">Rental Property Address</label>
                                <input type="text" id="propertyAddress" placeholder="Full address including city, state, zip">
                            </div>
                            
                            <div class="form-group">
                                <label for="landlordName">Landlord/Management Company</label>
                                <input type="text" id="landlordName" placeholder="Full name of landlord or company">
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label for="currentRent">Current Monthly Rent</label>
                                <input type="number" id="currentRent" placeholder="1200" step="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label for="proposedRent">Proposed New Rent</label>
                                <input type="number" id="proposedRent" placeholder="1500" step="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label for="rentIncreaseDate">Effective Date of Increase</label>
                                <input type="date" id="rentIncreaseDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="caseType">Primary Basis for Challenge</label>
                        <select id="caseType">
                            <option value="">Select the main reason for challenging this increase</option>
                            <option value="excessive_increase">Rent increase is excessive/unreasonable</option>
                            <option value="financial_hardship">Creates severe financial hardship</option>
                            <option value="market_disparity">Above-market rent for comparable properties</option>
                            <option value="property_condition">Property condition doesn't justify increase</option>
                            <option value="retaliation">Retaliatory rent increase</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="caseSummary">Brief Summary of Your Challenge</label>
                        <textarea id="caseSummary" placeholder="In 2-3 sentences, explain why you believe this rent increase should be reduced or denied..." rows="3"></textarea>
                    </div>
                    
                    <button class="btn" onclick="saveBasics()">Continue to Financial Analysis</button>
                </div>

                <!-- Financial Impact Section -->
                <div id="financial" class="section">
                    <h2>Financial Impact Analysis</h2>
                    <div class="alert">
                        <strong>Financial Hardship:</strong> This analysis demonstrates the impact of the rent increase on your household budget and will be included in your FRC filing.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group">
                                <label for="monthlyIncome">Total Monthly Household Income (before taxes)</label>
                                <input type="number" id="monthlyIncome" placeholder="4000" step="0.01">
                                <small>Include all income sources: wages, benefits, etc.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="householdSize">Number of People in Household</label>
                                <input type="number" id="householdSize" placeholder="2" min="1">
                            </div>
                        </div>
                        
                        <div>
                            <div class="form-group">
                                <label for="otherMajorExpenses">Other Major Monthly Expenses</label>
                                <input type="number" id="otherMajorExpenses" placeholder="1500" step="0.01">
                                <small>Utilities, food, transportation, medical, debt payments, etc.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="specialCircumstances">Special Financial Circumstances</label>
                                <select id="specialCircumstances">
                                    <option value="">None</option>
                                    <option value="fixed_income">Fixed income (Social Security, disability, pension)</option>
                                    <option value="medical_expenses">High medical expenses</option>
                                    <option value="job_loss">Recent job loss or reduced hours</option>
                                    <option value="student">Student with limited income</option>
                                    <option value="senior">Senior citizen on limited income</option>
                                    <option value="family_emergency">Family emergency/unexpected expenses</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Analysis Results -->
                    <div id="financialAnalysisResults" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none;">
                        <h3>Financial Impact Summary</h3>
                        <div id="financialAnalysisContent"></div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="analyzeFinancialImpact()">Analyze Financial Impact</button>
                    </div>
                </div>

                <!-- Evidence & Timeline Section -->
                <div id="evidence" class="section">
                    <h2>Evidence & Timeline</h2>
                    <div class="alert">
                        <strong>Supporting Evidence:</strong> Prepare your document checklist and create a timeline of events for your FRC filing.
                    </div>
                    
                    <h3>Document Preparation Checklist</h3>
                    <p>Gather these documents to submit with your FRC filing. Check off items as you collect them:</p>
                    
                    <div class="document-list">
                        <div class="document-item">
                            <div>
                                <input type="checkbox" id="lease-ready" onchange="updateDocStatus('lease')" style="margin-right: 15px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <strong>Current Lease Agreement</strong>
                                    <p>Shows current rent terms and lease conditions</p>
                                    <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">
                                        <strong>What to include:</strong> Signed lease with rent amount, lease term, landlord/tenant names
                                    </p>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge status-needed" id="lease-status">Required</span>
                            </div>
                        </div>
                        
                        <div class="document-item">
                            <div>
                                <input type="checkbox" id="notice-ready" onchange="updateDocStatus('notice')" style="margin-right: 15px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <strong>Rent Increase Notice</strong>
                                    <p>Official notice from landlord about the rent increase</p>
                                    <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">
                                        <strong>What to include:</strong> Original notice with new rent amount, effective date, landlord signature
                                    </p>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge status-needed" id="notice-status">Required</span>
                            </div>
                        </div>
                        
                        <div class="document-item">
                            <div>
                                <input type="checkbox" id="income-ready" onchange="updateDocStatus('income')" style="margin-right: 15px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <strong>Proof of Income</strong>
                                    <p>Documentation supporting your financial hardship analysis</p>
                                    <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">
                                        <strong>Options:</strong> Recent pay stubs, benefits statements, tax returns, Social Security statements
                                    </p>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge status-recommended" id="income-status">Recommended</span>
                            </div>
                        </div>
                        
                        <div class="document-item">
                            <div>
                                <input type="checkbox" id="comparable-ready" onchange="updateDocStatus('comparable')" style="margin-right: 15px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <strong>Comparable Rent Documentation</strong>
                                    <p>Evidence of similar properties with lower rents</p>
                                    <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">
                                        <strong>Examples:</strong> Rental listings, property manager quotes, real estate websites screenshots
                                    </p>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge status-optional" id="comparable-status">Optional</span>
                            </div>
                        </div>
                        
                        <div class="document-item">
                            <div>
                                <input type="checkbox" id="communications-ready" onchange="updateDocStatus('communications')" style="margin-right: 15px; transform: scale(1.2);">
                                <div style="flex: 1;">
                                    <strong>Communication Records</strong>
                                    <p>Correspondence with landlord about the rent increase</p>
                                    <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">
                                        <strong>Include:</strong> Emails, letters, text messages, notes from conversations
                                    </p>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge status-optional" id="communications-status">Optional</span>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Timeline of Events</h3>
                    <p>Create a chronological record of important events related to this case.</p>
                    
                    <div style="display: grid; grid-template-columns: 200px 1fr 120px; gap: 15px; margin: 20px 0;">
                        <div>
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate">
                        </div>
                        <div>
                            <label for="eventDescription">Event Description</label>
                            <input type="text" id="eventDescription" placeholder="e.g., Received rent increase notice">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button class="btn" onclick="addTimelineEvent()">Add Event</button>
                        </div>
                    </div>
                    
                    <div class="timeline" id="timelineContainer">
                        <!-- Timeline events will be added here -->
                    </div>
                </div>

                <!-- Market Analysis Section -->
                <div id="market" class="section">
                    <h2>Market Analysis</h2>
                    <div class="alert">
                        <strong>Comparable Rent Analysis:</strong> Research similar properties to demonstrate if your proposed rent is above market rate.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="propertyType">Property Type</label>
                            <select id="propertyType">
                                <option value="">Select type</option>
                                <option value="apartment">Apartment</option>
                                <option value="house">Single Family House</option>
                                <option value="condo">Condominium</option>
                                <option value="townhouse">Townhouse</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="bedrooms">Bedrooms</label>
                            <select id="bedrooms">
                                <option value="">Select bedrooms</option>
                                <option value="0">Studio</option>
                                <option value="1">1 Bedroom</option>
                                <option value="2">2 Bedrooms</option>
                                <option value="3">3 Bedrooms</option>
                                <option value="4">4+ Bedrooms</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="searchRadius">Search Area</label>
                            <select id="searchRadius">
                                <option value="1">1 mile radius</option>
                                <option value="2">2 mile radius</option>
                                <option value="5">5 mile radius</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="searchComparableRents()">🔍 Find Comparable Properties</button>
                    
                    <div id="marketAnalysisResults" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3>Market Analysis Results</h3>
                        <div id="marketAnalysisContent"></div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 30px;">
                        <label for="additionalComparables">Additional Comparable Properties (Optional)</label>
                        <textarea id="additionalComparables" placeholder="If you've found other comparable properties, list them here with addresses and rent amounts..." rows="4"></textarea>
                    </div>
                </div>

                <!-- FRC Filing Generation Section -->
                <div id="filing" class="section">
                    <h2>Generate Fair Rent Commission Filing</h2>
                    <div class="alert">
                        <strong>Professional FRC Submission:</strong> Generate a comprehensive report that can be filed directly with your Fair Rent Commission.
                    </div>
                    
                    <div class="form-group">
                        <label for="reliefRequested">Relief Requested from FRC</label>
                        <select id="reliefRequested">
                            <option value="">Select the outcome you're seeking</option>
                            <option value="deny_increase">Deny the rent increase entirely</option>
                            <option value="reduce_increase">Reduce the rent increase to a reasonable amount</option>
                            <option value="delay_increase">Delay the effective date of the increase</option>
                            <option value="rollback_rent">Roll back rent to previous amount</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalArguments">Additional Arguments or Special Circumstances</label>
                        <textarea id="additionalArguments" placeholder="Any additional points you want to emphasize in your filing..." rows="4"></textarea>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="generateFRCFiling()" style="font-size: 18px; padding: 15px 30px;">📋 Generate FRC Filing Report</button>
                    </div>
                    
                    <div id="frcFilingOutput" style="display: none; margin-top: 30px; padding: 30px; background: #f8f9fa; border-radius: 10px; border: 2px solid #667eea;">
                        <h3>Fair Rent Commission Filing Report</h3>
                        <div class="alert" style="background: #e8f5e8; border-color: #4caf50;">
                            <strong>Ready to File:</strong> This report is formatted for submission to your Fair Rent Commission and includes all required analysis and supporting evidence.
                        </div>
                        <div id="frcFilingContent"></div>
                        <div style="margin-top: 25px; text-align: center;">
                            <button class="btn" onclick="downloadFRCFilingPDF()" style="background: linear-gradient(45deg, #4caf50, #45a049); font-size: 16px; padding: 12px 25px; margin-right: 15px;">📄 Download PDF Filing</button>
                            <button class="btn" onclick="printFRCFiling()" style="background: linear-gradient(45deg, #2196f3, #1976d2); font-size: 16px; padding: 12px 25px;">🖨️ Print Filing</button>
                        </div>
                    </div>
                </div>

                <!-- Resources Section -->
                <div id="resources" class="section">
                    <h2>Fair Rent Commission Resources</h2>
                    
                    <div class="alert">
                        <strong>Next Steps:</strong> After generating your filing report, submit it to your local Fair Rent Commission along with your uploaded documents.
                    </div>
                    
                    <h3>Connecticut Towns with Fair Rent Commissions</h3>
                    <div class="document-list">
                        <div class="document-item">
                            <div>
                                <strong>Bridgeport Fair Rent Commission</strong>
                                <p>City Hall, 45 Lyon Terrace, Bridgeport, CT 06604</p>
                            </div>
                            <div>
                                <a href="https://www.bridgeportct.gov" target="_blank" class="btn">Contact Info</a>
                            </div>
                        </div>
                        <div class="document-item">
                            <div>
                                <strong>Hartford Fair Rent Commission</strong>
                                <p>City Hall, 550 Main Street, Hartford, CT 06103</p>
                            </div>
                            <div>
                                <a href="https://www.hartford.gov" target="_blank" class="btn">Contact Info</a>
                            </div>
                        </div>
                        <div class="document-item">
                            <div>
                                <strong>New Haven Fair Rent Commission</strong>
                                <p>City Hall, 165 Church Street, New Haven, CT 06510</p>
                            </div>
                            <div>
                                <a href="https://www.newhavenct.gov" target="_blank" class="btn">Contact Info</a>
                            </div>
                        </div>
                    </div>
                    
                    <h3>Filing Process</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <strong>Step 1: Complete This Tool</strong>
                            <p>Gather all information and generate your filing report.</p>
                        </div>
                        <div class="timeline-item">
                            <strong>Step 2: Submit to FRC</strong>
                            <p>File your report and documents with your local Fair Rent Commission within required timeframe (usually 30 days).</p>
                        </div>
                        <div class="timeline-item">
                            <strong>Step 3: FRC Review</strong>
                            <p>Commission staff reviews your filing and may request additional information.</p>
                        </div>
                        <div class="timeline-item">
                            <strong>Step 4: Hearing & Decision</strong>
                            <p>Attend public hearing before FRC board and receive written decision.</p>
                        </div>
                    </div>
                    
                    <div class="alert" style="margin-top: 30px;">
                        <strong>Legal Disclaimer:</strong> This tool provides general information and document generation assistance. For specific legal advice, consult with a qualified attorney familiar with Connecticut fair rent laws.
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let caseData = {};
let timelineEvents = [];
let documentsReady = {};
let currentMarketData = null;

function saveBasics() {
    caseData.tenantName = document.getElementById('tenantName').value;
    caseData.propertyAddress = document.getElementById('propertyAddress').value;
    caseData.landlordName = document.getElementById('landlordName').value;
    caseData.currentRent = document.getElementById('currentRent').value;
    caseData.proposedRent = document.getElementById('proposedRent').value;
    caseData.rentIncreaseDate = document.getElementById('rentIncreaseDate').value;
    caseData.caseType = document.getElementById('caseType').value;
    caseData.caseSummary = document.getElementById('caseSummary').value;
    
    localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
    alert('Case information saved successfully!');
    updateProgress();
    showSection('financial');
}

function analyzeFinancialImpact() {
    caseData.monthlyIncome = document.getElementById('monthlyIncome').value;
    caseData.otherMajorExpenses = document.getElementById('otherMajorExpenses').value;
    caseData.householdSize = document.getElementById('householdSize').value;
    caseData.specialCircumstances = document.getElementById('specialCircumstances').value;
    
    if (!caseData.monthlyIncome || !caseData.currentRent || !caseData.proposedRent) {
        alert('Please enter monthly income, current rent, and proposed rent to analyze financial impact.');
        return;
    }
    
    const currentBurden = ((parseFloat(caseData.currentRent) / parseFloat(caseData.monthlyIncome)) * 100).toFixed(1);
    const proposedBurden = ((parseFloat(caseData.proposedRent) / parseFloat(caseData.monthlyIncome)) * 100).toFixed(1);
    const exceedsAffordable = proposedBurden > 30;
    const increaseAmount = parseFloat(caseData.proposedRent) - parseFloat(caseData.currentRent);
    const annualIncrease = increaseAmount * 12;
    
    document.getElementById('financialAnalysisContent').innerHTML = `
        <div class="alert" style="background: ${exceedsAffordable ? '#ffebee' : '#e8f5e8'}; border-color: ${exceedsAffordable ? '#c62828' : '#4caf50'};">
            <strong>Financial Impact Assessment:</strong> The rent increase would ${exceedsAffordable ? 'exceed HUD affordability standards and create financial hardship' : 'be within HUD affordability guidelines but still creates increased burden'}.
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
            <div>
                <p><strong>Current Rent Burden:</strong> ${currentBurden}%</p>
                <p><strong>Proposed Rent Burden:</strong> ${proposedBurden}%</p>
                <p><strong>HUD Standard (Max):</strong> 30%</p>
            </div>
            <div>
                <p><strong>Monthly Increase:</strong> $${increaseAmount.toFixed(2)}</p>
                <p><strong>Annual Increase:</strong> $${annualIncrease.toLocaleString()}</p>
                <p><strong>Affordability Status:</strong> ${exceedsAffordable ? 'Exceeds Standards' : 'Within Standards'}</p>
            </div>
        </div>
        
        ${exceedsAffordable ? `
            <div class="alert" style="background: #ffebee; border-color: #c62828;">
                <strong>Key Arguments for FRC Filing:</strong><br>
                • Rent burden exceeds HUD 30% affordability standard<br>
                • Creates risk of displacement and financial hardship<br>
                • Annual increase of $${annualIncrease.toLocaleString()} impacts essential needs budget<br>
                • Violates federal housing affordability guidelines
            </div>
        ` : ''}
    `;
    
    document.getElementById('financialAnalysisResults').style.display = 'block';
    localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
    updateProgress();
}

function generateFRCFiling() {
    caseData.reliefRequested = document.getElementById('reliefRequested').value;
    caseData.additionalArguments = document.getElementById('additionalArguments').value;
    
    if (!caseData.reliefRequested) {
        alert('Please select the relief you are requesting from the FRC.');
        return;
    }
    
    const increaseAmount = parseFloat(caseData.proposedRent) - parseFloat(caseData.currentRent);
    const increasePercent = ((increaseAmount / parseFloat(caseData.currentRent)) * 100).toFixed(1);
    
    // Generate comprehensive financial analysis text
    let financialAnalysisText = 'Financial analysis not available - please complete the financial impact section above.';
    if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
        const currentBurden = ((parseFloat(caseData.currentRent) / parseFloat(caseData.monthlyIncome)) * 100).toFixed(1);
        const proposedBurden = ((parseFloat(caseData.proposedRent) / parseFloat(caseData.monthlyIncome)) * 100).toFixed(1);
        const exceedsAffordable = proposedBurden > 30;
        
        financialAnalysisText = `The tenant currently allocates ${currentBurden}% of household income toward rent. The proposed increase would raise this burden to ${proposedBurden}%, ${exceedsAffordable ? 'exceeding HUD affordability standards (30% maximum) and creating substantial financial hardship' : 'representing a significant increase in housing costs'}. The annual financial impact of $${(increaseAmount * 12).toLocaleString()} represents a ${increasePercent}% increase in housing costs, which ${exceedsAffordable ? 'violates federal housing affordability guidelines and threatens housing stability' : 'imposes a meaningful burden on the household budget'}.`;
    }
    
    // Generate market analysis text if available
    let marketAnalysisText = 'Market analysis not completed - consider using the Market Analysis section to strengthen your case.';
    let supportingComparables = '';
    
    if (currentMarketData) {
        const vsMarket = currentMarketData.vsMarket || 0;
        const proposedRent = parseFloat(caseData.proposedRent);
        marketAnalysisText = `Market analysis of comparable ${currentMarketData.propertyType} properties with ${currentMarketData.bedrooms} bedroom(s) shows the proposed rent is ${vsMarket > 0 ? vsMarket + '% above' : Math.abs(vsMarket) + '% below'} market average. ${vsMarket > 10 ? 'This significant deviation above market rates indicates the increase lacks justification based on current rental market conditions.' : 'The proposed rent appears consistent with local market conditions.'}`;
        
        // Include supporting comparable prices only if they support the case
        if (vsMarket > 0 && currentMarketData.comparables) {
            const supportingProps = currentMarketData.comparables.filter(prop => prop.rent < proposedRent);
            if (supportingProps.length > 0) {
                supportingComparables = `

<strong>Comparable Properties Supporting This Case:</strong>
${supportingProps.map(prop => 
    `• ${prop.address}: $${prop.rent}/month (${prop.bedrooms === 0 ? 'Studio' : prop.bedrooms + ' bedroom'} ${currentMarketData.propertyType}, ${prop.distance} miles away) - $${(proposedRent - prop.rent).toFixed(0)} less than proposed rent`
).join('\n')}

These comparable properties demonstrate that similar units in the area rent for significantly less than the proposed amount, supporting the argument that the increase is excessive.`;
            }
        }
    }
    
    const filingContent = `
        <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h3 style="margin: 0; color: #1976d2;">FAIR RENT COMMISSION FILING</h3>
            <p style="margin: 10px 0 0 0; font-weight: bold;">Case: ${caseData.tenantName || '[Tenant Name]'} vs. ${caseData.landlordName || '[Landlord Name]'}</p>
            <p style="margin: 5px 0 0 0;">Property: ${caseData.propertyAddress || '[Property Address]'}</p>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">Filing Date: ${new Date().toLocaleDateString()}</p>
        </div>

        <div style="margin-bottom: 25px;">
            <h4 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px;">I. CASE DETAILS & SUMMARY</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                <div>
                    <p><strong>Tenant:</strong> ${caseData.tenantName || '[Name]'}</p>
                    <p><strong>Property Address:</strong> ${caseData.propertyAddress || '[Address]'}</p>
                    <p><strong>Landlord/Manager:</strong> ${caseData.landlordName || '[Name]'}</p>
                    <p><strong>Case Type:</strong> ${caseData.caseType ? caseData.caseType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '[Type]'}</p>
                </div>
                <div>
                    <p><strong>Current Monthly Rent:</strong> $${caseData.currentRent || '[Amount]'}</p>
                    <p><strong>Proposed Monthly Rent:</strong> $${caseData.proposedRent || '[Amount]'}</p>
                    <p><strong>Increase Amount:</strong> $${increaseAmount > 0 ? increaseAmount.toFixed(2) : '[Amount]'}</p>
                    <p><strong>Increase Percentage:</strong> ${increasePercent}%</p>
                    <p><strong>Effective Date:</strong> ${caseData.rentIncreaseDate || '[Date]'}</p>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <p><strong>Summary of Challenge:</strong></p>
                <p style="background: #f8f9fa; padding: 15px; border-radius: 5px; line-height: 1.6; border-left: 4px solid #1976d2;">${caseData.caseSummary || 'Tenant challenges this rent increase as excessive and unreasonable under Connecticut Fair Rent Commission standards.'}</p>
            </div>
        </div>

        <div style="margin-bottom: 25px;">
            <h4 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px;">II. FINANCIAL HARDSHIP ANALYSIS</h4>
            <p style="line-height: 1.7; text-align: justify; margin: 15px 0;">${financialAnalysisText}</p>
            
            ${caseData.specialCircumstances ? `
                <div style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 5px; border-left: 4px solid #ff9800;">
                    <p><strong>Special Circumstances:</strong> ${caseData.specialCircumstances.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                    <p style="margin: 10px 0 0 0; font-size: 14px;">This circumstance further impacts the tenant's ability to absorb the proposed rent increase without compromising essential needs.</p>
                </div>
            ` : ''}
        </div>

        <div style="margin-bottom: 25px;">
            <h4 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px;">III. MARKET ANALYSIS</h4>
            <p style="line-height: 1.7; text-align: justify; margin: 15px 0;">${marketAnalysisText}</p>
            
            ${supportingComparables ? `
                <div style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 5px; border-left: 4px solid #4caf50;">
                    <p style="white-space: pre-line; margin: 0; line-height: 1.6;">${supportingComparables}</p>
                </div>
            ` : ''}
            
            ${caseData.additionalComparables ? `
                <div style="margin-top: 15px;">
                    <p><strong>Additional Comparable Properties Research:</strong></p>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 5px; line-height: 1.6; border-left: 4px solid #1976d2;">${caseData.additionalComparables}</p>
                </div>
            ` : ''}
        </div>

        ${timelineEvents.length > 0 ? `
            <div style="margin-bottom: 25px;">
                <h4 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px;">IV. CHRONOLOGY OF EVENTS</h4>
                <div style="margin: 15px 0;">
                    <p style="margin-bottom: 15px;">The following timeline documents key events related to this rent increase case:</p>
                    ${timelineEvents.map(event => `
                        <div style="margin: 10px 0; padding: 12px; background: #f8f9fa; border-left: 4px solid #1976d2; border-radius: 5px;">
                            <strong>${new Date(event.date).toLocaleDateString()}:</strong> ${event.description}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}

        <div style="margin-bottom: 25px;">
            <h4 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px;">${timelineEvents.length > 0 ? 'V' : 'IV'}. RELIEF REQUESTED</h4>
            <p style="margin: 15px 0;"><strong>Primary Relief Sought from Fair Rent Commission:</strong></p>
            <p style="background: #e3f2fd; padding: 15px; border-radius: 5px; font-weight: bold; margin: 10px 0; border-left: 4px solid #2196f3;">
                ${caseData.reliefRequested ? caseData.reliefRequested.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Relief not specified'}
            </p>
            
            <p style="margin: 15px 0; line-height: 1.6;">The tenant respectfully requests that the Fair Rent Commission find this rent increase to be excessive and unreasonable under Connecticut law, and grant the relief specified above to ensure continued housing affordability and prevent displacement.</p>
            
            ${caseData.additionalArguments ? `
                <div style="margin-top: 20px;">
                    <p style="margin: 15px 0;"><strong>Additional Arguments and Special Circumstances:</strong></p>
                    <p style="background: #f8f9fa; padding: 15px; border-radius: 5px; line-height: 1.6; border-left: 4px solid #667eea;">${caseData.additionalArguments}</p>
                </div>
            ` : ''}
        </div>

        <div style="margin-bottom: 25px;">
            <h4 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px;">${timelineEvents.length > 0 ? 'VI' : 'V'}. SUPPORTING EVIDENCE TO BE SUBMITTED</h4>
            <p style="margin: 15px 0;">The following supporting documents will be submitted with this filing:</p>
            <div style="margin: 15px 0;">
                ${Object.keys(documentsReady).some(doc => documentsReady[doc]) ? 
                    Object.keys(documentsReady).filter(doc => documentsReady[doc]).map(docType => {
                        return `
                            <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #4caf50;">
                                <p style="margin: 0 0 10px 0;"><strong>✓ ${docType.charAt(0).toUpperCase() + docType.slice(1).replace(/([A-Z])/g, ' $1').toLowerCase()}</strong></p>
                                <p style="margin: 5px 0; font-size: 14px; line-height: 1.4; color: #666;">${getDocumentRequirements(docType)}</p>
                            </div>
                        `;
                    }).join('') : 
                    '<p style="color: #666; font-style: italic;">No documents marked as ready in checklist - please review the evidence section</p>'
                }
            </div>
            
            <div style="margin-top: 15px; padding: 15px; background: #e8f4ff; border-radius: 5px; border-left: 4px solid #2196f3;">
                <p style="margin: 0 0 10px 0; font-size: 14px; line-height: 1.5;"><strong>Submission Instructions:</strong></p>
                <p style="margin: 0; font-size: 14px; line-height: 1.5;">All documents marked as ready above must be gathered and submitted as physical attachments or uploaded files according to Fair Rent Commission procedures. This filing serves as your formal petition and should be accompanied by the supporting evidence listed.</p>
            </div>
        </div>

        <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center; border: 2px solid #667eea;">
            <p style="margin: 0 0 20px 0; font-weight: bold; font-size: 16px;">CERTIFICATION</p>
            <p style="margin: 0 0 20px 0; line-height: 1.6; text-align: left;">I certify under penalty of perjury that the information provided in this filing is true and accurate to the best of my knowledge. I understand that providing false information to the Fair Rent Commission may result in dismissal of this case and potential legal consequences.</p>
            <p style="margin: 0; font-weight: bold;">Respectfully submitted on ${new Date().toLocaleDateString()}</p>
            <div style="margin: 30px 0;">
                <p style="margin: 20px 0 5px 0;">_________________________________</p>
                <p style="margin: 0; font-weight: bold;">${caseData.tenantName || '[Tenant Signature]'}</p>
                <p style="margin: 0; font-size: 14px; color: #666;">Tenant/Petitioner</p>
            </div>
        </div>
    `;
    
    document.getElementById('frcFilingContent').innerHTML = filingContent;
    document.getElementById('frcFilingOutput').style.display = 'block';
    
    localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
    updateProgress();
    
    // Scroll to the generated filing
    document.getElementById('frcFilingOutput').scrollIntoView({ behavior: 'smooth' });
}

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(sectionId).classList.add('active');
    
    // Update active nav button
    const buttons = document.querySelectorAll('.nav-btn');
    buttons.forEach(btn => {
        if (btn.onclick && btn.onclick.toString().includes(sectionId)) {
            btn.classList.add('active');
        }
    });
}

function addTimelineEvent() {
    const date = document.getElementById('eventDate').value;
    const description = document.getElementById('eventDescription').value;
    
    if (!date || !description) {
        alert('Please fill in both date and description');
        return;
    }
    
    timelineEvents.push({ date, description });
    timelineEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    renderTimeline();
    document.getElementById('eventDate').value = '';
    document.getElementById('eventDescription').value = '';
    localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
    updateProgress();
}

function renderTimeline() {
    const container = document.getElementById('timelineContainer');
    container.innerHTML = timelineEvents.map((event, index) => `
        <div class="timeline-item">
            <strong>${new Date(event.date).toLocaleDateString()}</strong>
            <p>${event.description}</p>
            <button class="btn" onclick="removeTimelineEvent(${index})" style="background: #dc3545; margin-top: 10px;">Remove</button>
        </div>
    `).join('');
}

function removeTimelineEvent(index) {
    timelineEvents.splice(index, 1);
    renderTimeline();
    localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
    updateProgress();
}

function updateDocStatus(docType) {
    const checkbox = document.getElementById(docType + '-ready');
    const statusElement = document.getElementById(docType + '-status');
    
    if (checkbox.checked) {
        statusElement.textContent = 'Ready';
        statusElement.classList.remove('status-needed', 'status-recommended', 'status-optional');
        statusElement.classList.add('status-ready');
        documentsReady[docType] = true;
    } else {
        // Reset to original status
        documentsReady[docType] = false;
        const originalStatus = getOriginalStatus(docType);
        statusElement.textContent = originalStatus.text;
        statusElement.classList.remove('status-ready');
        statusElement.classList.add(originalStatus.class);
    }
    
    localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
    updateProgress();
}

function getOriginalStatus(docType) {
    const statuses = {
        'lease': { text: 'Required', class: 'status-needed' },
        'notice': { text: 'Required', class: 'status-needed' },
        'income': { text: 'Recommended', class: 'status-recommended' },
        'comparable': { text: 'Optional', class: 'status-optional' },
        'communications': { text: 'Optional', class: 'status-optional' }
    };
    return statuses[docType] || { text: 'Optional', class: 'status-optional' };
}

function getDocumentRequirements(docType) {
    const requirements = {
        'lease': 'Submit your signed lease agreement showing current rent amount, lease term, and all parties\' names',
        'notice': 'Include the original rent increase notice with new rent amount, effective date, and landlord signature',
        'income': 'Provide recent pay stubs, benefits statements, or tax returns to support financial hardship claims',
        'comparable': 'Include rental listings, property manager quotes, or real estate website screenshots showing lower rents',
        'communications': 'Submit emails, letters, text messages, or documented phone conversations with landlord'
    };
    return requirements[docType] || 'Supporting documentation for your FRC case';
}

function searchComparableRents() {
    const propertyType = document.getElementById('propertyType').value;
    const bedrooms = document.getElementById('bedrooms').value;
    const searchRadius = document.getElementById('searchRadius').value;
    
    if (!propertyType || !bedrooms) {
        alert('Please select property type and number of bedrooms');
        return;
    }

    // Show loading state
    const button = event.target;
    button.textContent = '🔍 Searching...';
    button.disabled = true;

    // Simulate market analysis with realistic data
    setTimeout(() => {
        const baseRent = parseFloat(caseData.currentRent) || 1200;
        const marketRent = baseRent * (0.85 + Math.random() * 0.3); // ±15% variation
        const proposedRent = parseFloat(caseData.proposedRent) || baseRent * 1.2;
        const vsMarket = Math.round(((proposedRent - marketRent) / marketRent) * 100);

        // Generate sample comparable properties
        const comparables = [];
        for (let i = 0; i < 5; i++) {
            const variation = (Math.random() - 0.5) * 0.2; // ±10% variation
            comparables.push({
                address: `${Math.floor(Math.random() * 999) + 1} ${['Oak St', 'Main St', 'Elm Ave', 'Park Dr', 'Church St'][i]}`,
                rent: Math.round(marketRent * (1 + variation)),
                bedrooms: parseInt(bedrooms) + (Math.random() > 0.8 ? (Math.random() > 0.5 ? 1 : -1) : 0),
                distance: (Math.random() * parseFloat(searchRadius)).toFixed(1)
            });
        }

        const resultsDiv = document.getElementById('marketAnalysisResults');
        const contentDiv = document.getElementById('marketAnalysisContent');

        contentDiv.innerHTML = `
            <div class="alert" style="background: ${vsMarket > 10 ? '#ffebee' : '#e8f5e8'}; border-color: ${vsMarket > 10 ? '#c62828' : '#4caf50'};">
                <strong>Market Analysis Conclusion:</strong> 
                The proposed rent appears to be <strong>${vsMarket > 10 ? 'significantly above market rate' : vsMarket > 0 ? 'above market rate' : 'consistent with market rates'}</strong> based on comparable properties.
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4>Market Summary</h4>
                    <p><strong>Average Market Rent:</strong> $${Math.round(marketRent)}</p>
                    <p><strong>Your Proposed Rent:</strong> $${proposedRent}</p>
                    <p><strong>Market Difference:</strong> ${vsMarket > 0 ? '+' : ''}${vsMarket}%</p>
                    <p><strong>Property Type:</strong> ${propertyType}</p>
                </div>
                <div>
                    <h4>Search Parameters</h4>
                    <p><strong>Bedrooms:</strong> ${bedrooms === '0' ? 'Studio' : bedrooms + ' bedroom(s)'}</p>
                    <p><strong>Search Area:</strong> ${searchRadius} mile radius</p>
                    <p><strong>Properties Found:</strong> ${comparables.length}</p>
                    <p><strong>Data Source:</strong> Simulated market data</p>
                </div>
            </div>

            ${vsMarket > 0 ? `
                <h4>Comparable Properties Supporting Your Case</h4>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Only showing properties with lower rents that support your argument:</p>
                <div style="margin: 15px 0;">
                    ${comparables.filter(prop => prop.rent < proposedRent).map(prop => `
                        <div class="document-item" style="margin: 8px 0;">
                            <div>
                                <strong>${prop.address}</strong>
                                <p>${prop.bedrooms === 0 ? 'Studio' : prop.bedrooms + ' bedroom'} ${propertyType} - ${prop.distance} miles away</p>
                            </div>
                            <div>
                                <strong style="color: #2e7d32;">$${prop.rent}/month</strong>
                                <p style="font-size: 12px; color: #666; margin: 0;">$${(proposedRent - prop.rent).toFixed(0)} less than proposed</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <h4>All Comparable Properties</h4>
                <div style="margin: 15px 0;">
                    ${comparables.map(prop => `
                        <div class="document-item" style="margin: 8px 0;">
                            <div>
                                <strong>${prop.address}</strong>
                                <p>${prop.bedrooms === 0 ? 'Studio' : prop.bedrooms + ' bedroom'} ${propertyType} - ${prop.distance} miles away</p>
                            </div>
                            <div>
                                <strong style="color: ${prop.rent > proposedRent ? '#c62828' : '#2e7d32'};">$${prop.rent}/month</strong>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}

            ${vsMarket > 10 ? `
                <div class="alert" style="background: #ffebee; border-color: #c62828;">
                    <strong>Key Arguments for FRC Filing:</strong><br>
                    • Proposed rent is ${vsMarket}% above market average for comparable properties<br>
                    • Market analysis shows similar ${propertyType}s rent for significantly less<br>
                    • Increase lacks justification based on current market conditions<br>
                    • Exceeds reasonable rent levels for the area and property type
                </div>
            ` : vsMarket > 0 ? `
                <div class="alert" style="background: #fff3e0; border-color: #ff9800;">
                    <strong>Market Analysis Notes:</strong><br>
                    • Proposed rent is ${vsMarket}% above market average<br>
                    • Consider emphasizing other factors like financial hardship<br>
                    • Market data supports argument for moderation of increase
                </div>
            ` : `
                <div class="alert" style="background: #e8f5e8; border-color: #4caf50;">
                    <strong>Market Analysis Notes:</strong><br>
                    • Proposed rent appears consistent with market rates<br>
                    • Focus on financial hardship and affordability arguments<br>
                    • Consider other factors like property condition or special circumstances
                </div>
            `}
        `;

        resultsDiv.style.display = 'block';
        currentMarketData = { marketRent, vsMarket, propertyType, bedrooms, comparables };
        localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
        updateProgress();

        button.textContent = '🔍 Find Comparable Properties';
        button.disabled = false;
    }, 2500);
}

function updateProgress() {
    let completed = 0;
    const total = 6;
    
    // Case information
    if (caseData.tenantName && caseData.currentRent && caseData.proposedRent && caseData.caseType) completed++;
    
    // Financial analysis
    if (caseData.monthlyIncome && document.getElementById('financialAnalysisResults').style.display === 'block') completed++;
    
    // Evidence/Timeline
    if (Object.keys(documentsReady).some(doc => documentsReady[doc]) || timelineEvents.length > 0) completed++;
    
    // Market analysis
    if (currentMarketData) completed++;
    
    // FRC filing generated
    if (document.getElementById('frcFilingOutput').style.display === 'block') completed++;
    
    // Resources (always available)
    completed++;
    
    const percent = Math.round((completed / total) * 100);
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = percent + '% Complete';
}

function downloadFRCFilingPDF() {
    try {
        if (!window.jsPDF) {
            alert('PDF library not loaded. Please use the print option instead.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Set up PDF styling
        const margin = 20;
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        let yPosition = margin;
        
        // Helper function to add text with word wrapping
        function addText(text, fontSize = 10, fontStyle = 'normal', color = [0, 0, 0]) {
            doc.setFontSize(fontSize);
            doc.setFont('helvetica', fontStyle);
            doc.setTextColor(color[0], color[1], color[2]);
            
            const maxWidth = pageWidth - (margin * 2);
            const lines = doc.splitTextToSize(text, maxWidth);
            
            for (let line of lines) {
                if (yPosition > pageHeight - 30) {
                    doc.addPage();
                    yPosition = margin;
                }
                doc.text(line, margin, yPosition);
                yPosition += fontSize * 0.5;
            }
            yPosition += 5;
        }
        
        // Helper function to add headings
        function addHeading(text, level = 1) {
            yPosition += 5;
            const fontSize = level === 1 ? 16 : 12;
            addText(text, fontSize, 'bold', [25, 118, 210]);
            yPosition += 3;
        }
        
        // Generate PDF content
        addHeading('FAIR RENT COMMISSION FILING', 1);
        addText(`Case: ${caseData.tenantName || '[Tenant Name]'} vs. ${caseData.landlordName || '[Landlord Name]'}`, 12, 'bold');
        addText(`Property: ${caseData.propertyAddress || '[Property Address]'}`);
        addText(`Filing Date: ${new Date().toLocaleDateString()}`);
        
        addHeading('I. CASE DETAILS & SUMMARY', 2);
        addText(`Tenant: ${caseData.tenantName || '[Name]'}`);
        addText(`Property Address: ${caseData.propertyAddress || '[Address]'}`);
        addText(`Landlord/Manager: ${caseData.landlordName || '[Name]'}`);
        addText(`Case Type: ${caseData.caseType ? caseData.caseType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '[Type]'}`);
        addText(`Current Monthly Rent: $${caseData.currentRent || '[Amount]'}`);
        addText(`Proposed Monthly Rent: $${caseData.proposedRent || '[Amount]'}`);
        
        const increaseAmount = parseFloat(caseData.proposedRent) - parseFloat(caseData.currentRent);
        const increasePercent = ((increaseAmount / parseFloat(caseData.currentRent)) * 100).toFixed(1);
        addText(`Increase Amount: $${increaseAmount > 0 ? increaseAmount.toFixed(2) : '[Amount]'} (${increasePercent}%)`);
        addText(`Effective Date: ${caseData.rentIncreaseDate || '[Date]'}`);
        
        addText(`Summary of Challenge: ${caseData.caseSummary || 'Tenant challenges this rent increase as excessive and unreasonable.'}`);
        
        addHeading('II. FINANCIAL HARDSHIP ANALYSIS', 2);
        if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
            const currentBurden = ((parseFloat(caseData.currentRent) / parseFloat(caseData.monthlyIncome)) * 100).toFixed(1);
            const proposedBurden = ((parseFloat(caseData.proposedRent) / parseFloat(caseData.monthlyIncome)) * 100).toFixed(1);
            const exceedsAffordable = proposedBurden > 30;
            
            addText(`The tenant currently allocates ${currentBurden}% of household income toward rent. The proposed increase would raise this burden to ${proposedBurden}%, ${exceedsAffordable ? 'exceeding HUD affordability standards (30% maximum) and creating substantial financial hardship' : 'representing a significant increase in housing costs'}.`);
        } else {
            addText('Financial analysis not available - please complete financial impact section.');
        }
        
        addHeading('III. MARKET ANALYSIS', 2);
        if (currentMarketData) {
            const vsMarket = currentMarketData.vsMarket || 0;
            addText(`Market analysis shows the proposed rent is ${vsMarket > 0 ? vsMarket + '% above' : Math.abs(vsMarket) + '% below'} market average.`);
            
            if (vsMarket > 0 && currentMarketData.comparables) {
                const supportingProps = currentMarketData.comparables.filter(prop => prop.rent < parseFloat(caseData.proposedRent));
                if (supportingProps.length > 0) {
                    addText('Comparable Properties Supporting This Case:', 10, 'bold');
                    supportingProps.forEach(prop => {
                        addText(`• ${prop.address}: $${prop.rent}/month (${prop.bedrooms === 0 ? 'Studio' : prop.bedrooms + ' bedroom'}) - $${(parseFloat(caseData.proposedRent) - prop.rent).toFixed(0)} less than proposed`);
                    });
                }
            }
        } else {
            addText('Market analysis not completed.');
        }
        
        if (timelineEvents.length > 0) {
            addHeading('IV. CHRONOLOGY OF EVENTS', 2);
            timelineEvents.forEach(event => {
                addText(`${new Date(event.date).toLocaleDateString()}: ${event.description}`);
            });
        }
        
        addHeading(`${timelineEvents.length > 0 ? 'V' : 'IV'}. RELIEF REQUESTED`, 2);
        addText(`Primary Relief Sought: ${caseData.reliefRequested ? caseData.reliefRequested.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Relief not specified'}`, 10, 'bold');
        
        if (caseData.additionalArguments) {
            addText(`Additional Arguments: ${caseData.additionalArguments}`);
        }
        
        addHeading(`${timelineEvents.length > 0 ? 'VI' : 'V'}. SUPPORTING EVIDENCE TO BE SUBMITTED`, 2);
        if (Object.keys(documentsReady).some(doc => documentsReady[doc])) {
            Object.keys(documentsReady).filter(doc => documentsReady[doc]).forEach(docType => {
                addText(`✓ ${docType.charAt(0).toUpperCase() + docType.slice(1).replace(/([A-Z])/g, ' $1').toLowerCase()}`, 10, 'bold');
                addText(`${getDocumentRequirements(docType)}`, 8);
            });
            addText('', 8);
            addText('All documents listed above must be gathered and submitted as physical attachments with this filing.', 8);
        } else {
            addText('No documents marked as ready in checklist - please review the evidence section.');
        }
        
        // Certification
        yPosition += 10;
        addText('CERTIFICATION', 12, 'bold');
        addText('I certify under penalty of perjury that the information provided in this filing is true and accurate to the best of my knowledge.');
        addText(`Respectfully submitted on ${new Date().toLocaleDateString()}`, 10, 'bold');
        
        yPosition += 20;
        addText('_________________________________');
        addText(`${caseData.tenantName || '[Tenant Signature]'}`, 10, 'bold');
        addText('Tenant/Petitioner', 8);
        
        // Generate filename and save
        const tenantName = caseData.tenantName || 'Tenant';
        const cleanName = tenantName.replace(/[^a-zA-Z0-9]/g, '_');
        const filename = `FRC_Filing_${cleanName}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        doc.save(filename);
        
        // Show success message
        setTimeout(() => {
            alert(`✅ PDF generated successfully!\n\nFile: ${filename}\n\nThe PDF includes all your case information and is ready for submission to the Fair Rent Commission.`);
        }, 500);
        
    } catch (error) {
        console.error('PDF generation error:', error);
        alert('Error generating PDF. Please try the print option instead, which allows you to save as PDF from your browser.');
    }
}

function printFRCFiling() {
    const printContent = document.getElementById('frcFilingContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Fair Rent Commission Filing - ${caseData.tenantName || 'Tenant'}</title>
                <style>
                    body { 
                        font-family: 'Times New Roman', serif; 
                        margin: 0.5in; 
                        line-height: 1.6; 
                        color: #000;
                    }
                    h3, h4 { 
                        color: #1976d2; 
                        page-break-after: avoid;
                    }
                    h4 { 
                        border-bottom: 2px solid #1976d2; 
                        padding-bottom: 5px; 
                        margin-top: 25px;
                    }
                    .alert { 
                        background: #f8f9fa; 
                        padding: 15px; 
                        border-radius: 5px; 
                        margin: 10px 0; 
                        border-left: 4px solid #1976d2;
                    }
                    p { margin: 10px 0; }
                    @media print { 
                        body { margin: 0.5in; font-size: 12pt; }
                        .no-print { display: none; }
                        h4 { page-break-after: avoid; }
                        .timeline-item, .document-item { page-break-inside: avoid; }
                    }
                </style>
            </head>
            <body>
                ${printContent}
                <div style="margin-top: 40px; font-size: 10pt; color: #666; text-align: center;">
                    Generated by CT Fair Rent Commission Case Prep Tool - ${new Date().toLocaleString()}
                </div>
            </body>
        </html>
    `);
    printWindow.print();
}

function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem('frcCaseData');
        if (saved) {
            const data = JSON.parse(saved);
            caseData = data.caseData || {};
            timelineEvents = data.timelineEvents || [];
            documentsReady = data.documentsReady || {};
            currentMarketData = data.currentMarketData || null;
            
            // Restore form values
            Object.keys(caseData).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = caseData[key];
            });
            
            // Restore document checkbox status
            Object.keys(documentsReady).forEach(docType => {
                if (documentsReady[docType]) {
                    const checkbox = document.getElementById(docType + '-ready');
                    if (checkbox) {
                        checkbox.checked = true;
                        const statusElement = document.getElementById(docType + '-status');
                        if (statusElement) {
                            statusElement.textContent = 'Ready';
                            statusElement.classList.remove('status-needed', 'status-recommended', 'status-optional');
                            statusElement.classList.add('status-ready');
                        }
                    }
                }
            });
            
            // Restore timeline
            renderTimeline();
            
            // Restore financial analysis if data exists
            if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
                analyzeFinancialImpact();
            }
            
            // Restore market analysis if data exists
            if (currentMarketData) {
                document.getElementById('marketAnalysisResults').style.display = 'block';
            }
            
            updateProgress();
        }
    } catch (error) {
        console.error('Error loading saved data:', error);
    }
}

function setupAutoSave() {
    const inputs = ['tenantName', 'propertyAddress', 'landlordName', 'currentRent', 'proposedRent', 
                   'rentIncreaseDate', 'caseType', 'caseSummary', 'monthlyIncome', 'otherMajorExpenses', 
                   'householdSize', 'specialCircumstances', 'reliefRequested', 'additionalArguments', 'additionalComparables'];
    
    inputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
                    element.addEventListener('input', function() {
            caseData[inputId] = this.value;
            localStorage.setItem('frcCaseData', JSON.stringify({caseData, timelineEvents, documentsReady, currentMarketData}));
                
                // Auto-update financial analysis if relevant fields change
                if (['monthlyIncome', 'currentRent', 'proposedRent', 'otherMajorExpenses'].includes(inputId)) {
                    if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
                        setTimeout(analyzeFinancialImpact, 500);
                    }
                }
            });
        }
    });
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    loadFromLocalStorage();
    setupAutoSave();
    updateProgress();
    
    console.log('🎯 FRC Case Builder v4.0 - Streamlined for Single Comprehensive Filing');
    console.log('✅ Auto-save enabled');
    console.log('✅ Progress tracking active');
    console.log('✅ Professional FRC filing generation ready');
});
</script>

</body>
</html>
