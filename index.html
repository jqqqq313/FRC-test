<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Fair Rent Commission Case Prep Tool</title>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
        color: white;
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.2em;
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .sidebar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .main-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .nav-btn {
        display: block;
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .nav-btn.active {
        background: linear-gradient(45deg, #764ba2, #667eea);
        transform: scale(1.05);
    }

    .section {
        display: none;
    }

    .section.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
        margin-bottom: 20px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
    }

    input, textarea, select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #667eea;
    }

    textarea {
        resize: vertical;
        min-height: 100px;
    }

    .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .checklist {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .checklist-item {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .checklist-item input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
    }

    .progress-bar {
        background: #e0e0e0;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        transition: width 0.3s ease;
    }

    .alert {
        padding: 15px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        background: #e8f4ff;
    }

    .timeline {
        position: relative;
        margin: 20px 0;
    }

    .timeline-item {
        position: relative;
        padding: 20px;
        margin: 10px 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }

    .document-list {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .document-item {
        padding: 15px;
        margin: 10px 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-needed {
        background: #ffebee;
        color: #c62828;
    }

    .status-uploaded {
        background: #e8f5e8;
        color: #2e7d32;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .header h1 {
            font-size: 2em;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Connecticut Fair Rent Commission Case Prep Tool</h1>
            <p>Comprehensive case preparation for tenant rent disputes</p>
        </div>

```
    <div class="main-content">
        <div class="sidebar">
            <h3>Win Your FRC Case</h3>
            <button class="nav-btn active" onclick="showSection('basics')">1. Case Basics</button>
            <button class="nav-btn" onclick="showSection('documents')">2. Document Collection</button>
            <button class="nav-btn" onclick="showSection('timeline')">3. Timeline Builder</button>
            <button class="nav-btn" onclick="showSection('complaint')">4. Complaint Form</button>
            <button class="nav-btn" onclick="showSection('preparation')">5. Hearing Preparation</button>
            <button class="nav-btn" onclick="showSection('report')">6. Case Report</button>
            <button class="nav-btn" onclick="showSection('market-analysis')">7. Market Analysis</button>
            <button class="nav-btn" onclick="showSection('legal-research')">8. Legal Research</button>
            <button class="nav-btn" onclick="showSection('resources')">9. Resources</button>
            
            <div style="margin-top: 30px;">
                <h4>Case Progress</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <p id="progressText">0% Complete</p>
            </div>
        </div>

        <div class="main-panel">
            <!-- Case Basics Section -->
            <div id="basics" class="section active">
                <h2>Case Basics</h2>
                <div class="alert">
                    <strong>Important:</strong> Fair Rent Commissions exist in Connecticut towns with 25,000+ residents. Check if your town has an FRC before proceeding.
                </div>
                
                <div class="form-group">
                    <label for="tenantName">Tenant Name</label>
                    <input type="text" id="tenantName" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="propertyAddress">Property Address</label>
                    <input type="text" id="propertyAddress" placeholder="Full address of rental property">
                </div>
                
                <div class="form-group">
                    <label for="landlordName">Landlord/Property Manager Name</label>
                    <input type="text" id="landlordName" placeholder="Name of landlord or property management company">
                </div>
                
                <div class="form-group">
                    <label for="currentRent">Current Monthly Rent</label>
                    <input type="number" id="currentRent" placeholder="1200">
                </div>
                
                <div class="form-group">
                    <label for="proposedRent">Proposed New Rent</label>
                    <input type="number" id="proposedRent" placeholder="1500">
                </div>
                
                <div class="form-group">
                    <label for="rentIncreaseDate">Effective Date of Rent Increase</label>
                    <input type="date" id="rentIncreaseDate">
                </div>
                
                <div class="form-group">
                    <label for="caseType">Type of Complaint</label>
                    <select id="caseType">
                        <option value="">Select complaint type</option>
                        <option value="excessive_increase">Excessive Rent Increase</option>
                        <option value="protected_tenant">Protected Tenant Rights</option>
                        <option value="habitability">Habitability Issues</option>
                        <option value="retaliation">Retaliation</option>
                    </select>
                </div>

                <!-- Financial Information for Hardship Analysis -->
                <h3 style="margin-top: 30px; color: #667eea;">Financial Information</h3>
                <div class="alert">
                    <strong>Note:</strong> This information helps calculate financial hardship and strengthen your case.
                </div>
                
                <div class="form-group">
                    <label for="monthlyIncome">Monthly Household Income (before taxes)</label>
                    <input type="number" id="monthlyIncome" placeholder="4000">
                </div>
                
                <div class="form-group">
                    <label for="monthlyExpenses">Other Monthly Expenses (utilities, food, transportation, etc.)</label>
                    <input type="number" id="monthlyExpenses" placeholder="1500">
                </div>
                
                <div class="form-group">
                    <label for="householdSize">Number of People in Household</label>
                    <input type="number" id="householdSize" placeholder="2" min="1">
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="saveBasics()">Save Case Basics</button>
                    <button class="btn" onclick="testSave()" style="background: #17a2b8; margin-left: 10px; font-size: 14px;">🔧 Test Save (Debug)</button>
                </div>
                
                <!-- Financial Hardship Analysis -->
                <div id="hardshipAnalysis" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h4>Financial Hardship Analysis</h4>
                    <div id="hardshipResults"></div>
                </div>
            </div>

            <!-- Document Collection Section -->
            <div id="documents" class="section">
                <h2>Document Collection Checklist</h2>
                <p>Gather all necessary documents for your FRC case. Required documents vary by case type.</p>
                
                <div class="document-list">
                    <h3>Required Documents</h3>
                    <div class="document-item">
                        <div>
                            <strong>Current Lease Agreement</strong>
                            <p>Your signed lease showing current rent terms</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="lease-status">Needed</span>
                            <input type="file" id="lease-file" style="display: none;" onchange="updateDocStatus('lease')">
                            <button class="btn" onclick="document.getElementById('lease-file').click()">Upload</button>
                        </div>
                    </div>
                    
                    <div class="document-item">
                        <div>
                            <strong>Rent Increase Notice</strong>
                            <p>Official notice from landlord about rent increase</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="notice-status">Needed</span>
                            <input type="file" id="notice-file" style="display: none;" onchange="updateDocStatus('notice')">
                            <button class="btn" onclick="document.getElementById('notice-file').click()">Upload</button>
                        </div>
                    </div>
                    
                    <div class="document-item">
                        <div>
                            <strong>Proof of Current Rent Payments</strong>
                            <p>Bank statements, receipts, or payment records</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="payments-status">Needed</span>
                            <input type="file" id="payments-file" style="display: none;" onchange="updateDocStatus('payments')">
                            <button class="btn" onclick="document.getElementById('payments-file').click()">Upload</button>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Additional Supporting Documents</h3>
                    <div class="document-item">
                        <div>
                            <strong>Comparable Rent Research</strong>
                            <p>Documentation of similar units' rent in your area</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="comparables-status">Optional</span>
                            <input type="file" id="comparables-file" style="display: none;" onchange="updateDocStatus('comparables')">
                            <button class="btn" onclick="document.getElementById('comparables-file').click()">Upload</button>
                        </div>
                    </div>

                    <div class="document-item">
                        <div>
                            <strong>Building Code Violations</strong>
                            <p>Records of habitability issues or code violations</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="violations-status">Optional</span>
                            <input type="file" id="violations-file" style="display: none;" onchange="updateDocStatus('violations')">
                            <button class="btn" onclick="document.getElementById('violations-file').click()">Upload</button>
                        </div>
                    </div>

                    <div class="document-item">
                        <div>
                            <strong>Income Documentation</strong>
                            <p>Pay stubs, benefits statements, tax returns</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="income-status">Optional</span>
                            <input type="file" id="income-file" style="display: none;" onchange="updateDocStatus('income')">
                            <button class="btn" onclick="document.getElementById('income-file').click()">Upload</button>
                        </div>
                    </div>

                    <div class="document-item">
                        <div>
                            <strong>Communication Records</strong>
                            <p>Emails, letters, or texts with landlord about rent increase</p>
                        </div>
                        <div>
                            <span class="status-badge status-needed" id="communications-status">Optional</span>
                            <input type="file" id="communications-file" style="display: none;" onchange="updateDocStatus('communications')">
                            <button class="btn" onclick="document.getElementById('communications-file').click()">Upload</button>
                        </div>
                    </div>
                </div>

                <!-- Evidence Strength Analysis -->
                <div id="evidenceAnalysis" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>Evidence Strength Analysis</h3>
                    <div class="progress-bar" style="margin: 15px 0;">
                        <div class="progress-fill" id="evidenceStrengthBar" style="width: 0%"></div>
                    </div>
                    <div id="evidenceStrengthText">Evidence Strength: 0%</div>
                    
                    <div id="evidenceRecommendations" style="margin-top: 15px;">
                        <h4>Recommendations to Strengthen Your Case:</h4>
                        <div id="recommendationsList"></div>
                    </div>
                    
                    <div id="missingRequired" style="margin-top: 15px; display: none;">
                        <h4 style="color: #c62828;">Missing Required Documents:</h4>
                        <div id="missingRequiredList"></div>
                    </div>
                </div>
            </div>

            <!-- Timeline Builder Section -->
            <div id="timeline" class="section">
                <h2>Case Timeline Builder</h2>
                <p>Create a chronological timeline of events related to your case.</p>
                
                <div class="form-group">
                    <label for="eventDate">Event Date</label>
                    <input type="date" id="eventDate">
                </div>
                
                <div class="form-group">
                    <label for="eventDescription">Event Description</label>
                    <textarea id="eventDescription" placeholder="Describe what happened on this date..."></textarea>
                </div>
                
                <button class="btn" onclick="addTimelineEvent()">Add Event</button>
                
                <div class="timeline" id="timelineContainer">
                    <!-- Timeline events will be added here -->
                </div>
            </div>

            <!-- Complaint Form Section -->
            <div id="complaint" class="section">
                <h2>Fair Rent Commission Complaint Form</h2>
                <p>Complete your formal complaint to submit to the Fair Rent Commission.</p>
                
                <div class="form-group">
                    <label for="complaintSummary">Complaint Summary</label>
                    <textarea id="complaintSummary" placeholder="Briefly describe your complaint and what you're seeking..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="rentIncrease">Rent Increase Details</label>
                    <textarea id="rentIncrease" placeholder="Describe the rent increase: amount, notice given, reasons provided by landlord..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="whyExcessive">Why is the increase excessive?</label>
                    <textarea id="whyExcessive" placeholder="Explain why you believe the rent increase is excessive or unreasonable..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="reliefSought">Relief Sought</label>
                    <textarea id="reliefSought" placeholder="What do you want the Fair Rent Commission to do? (e.g., reduce rent increase, maintain current rent, etc.)"></textarea>
                </div>
                
                <button class="btn" onclick="generateComplaint()">Generate Complaint Form</button>
                
                <div id="complaintOutput" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>Generated Complaint</h3>
                    <div id="complaintText"></div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="printComplaint()" style="margin-right: 10px;">Print Complaint</button>
                        <button class="btn" onclick="downloadComplaintPDF()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">📄 Download PDF</button>
                    </div>
                </div>
            </div>

            <!-- Hearing Preparation Section -->
            <div id="preparation" class="section">
                <h2>Hearing Preparation</h2>
                <p>Prepare for your Fair Rent Commission hearing with this comprehensive checklist.</p>
                
                <div class="checklist">
                    <h3>Pre-Hearing Checklist</h3>
                    <div class="checklist-item">
                        <input type="checkbox" id="prep1" onchange="updateProgress()">
                        <label for="prep1">Review all submitted documents and evidence</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="prep2" onchange="updateProgress()">
                        <label for="prep2">Prepare opening statement (3-5 minutes)</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="prep3" onchange="updateProgress()">
                        <label for="prep3">Organize evidence in chronological order</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="prep4" onchange="updateProgress()">
                        <label for="prep4">Prepare list of key points to make</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="openingStatement">Opening Statement Draft</label>
                    <textarea id="openingStatement" placeholder="Draft your opening statement here. Keep it concise and focus on key facts..."></textarea>
                </div>
                
                <button class="btn" onclick="saveHearingPrep()">Save Hearing Preparation</button>
            </div>

            <!-- Case Report Section -->
            <div id="report" class="section">
                <h2>Case Report</h2>
                <p>Generate a comprehensive report of your case for submission to the Fair Rent Commission.</p>
                
                <div class="form-group">
                    <label for="reportTitle">Report Title</label>
                    <input type="text" id="reportTitle" placeholder="e.g., Rent Increase Dispute Report">
                </div>
                
                <div class="form-group">
                    <label for="reportSummary">Report Summary</label>
                    <textarea id="reportSummary" placeholder="A brief summary of the case, including key points and findings."></textarea>
                </div>
                
                <button class="btn" onclick="generateCaseReport()">Generate Case Report</button>
                
                <div id="caseReportOutput" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>Generated Case Report</h3>
                    <div id="caseReportText"></div>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="printCaseReport()" style="margin-right: 10px;">Print Report</button>
                        <button class="btn" onclick="downloadCaseReportPDF()" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">📄 Download PDF</button>
                    </div>
                </div>
            </div>

            <!-- Market Analysis Section -->
            <div id="market-analysis" class="section">
                <h2>Market Analysis & Comparable Rents</h2>
                <p>Research comparable rental properties to support your case that the proposed increase is excessive.</p>
                
                <div class="form-group">
                    <label for="propertyType">Property Type</label>
                    <select id="propertyType">
                        <option value="">Select property type</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">Single Family House</option>
                        <option value="condo">Condominium</option>
                        <option value="townhouse">Townhouse</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bedrooms">Number of Bedrooms</label>
                    <select id="bedrooms">
                        <option value="">Select bedrooms</option>
                        <option value="0">Studio</option>
                        <option value="1">1 Bedroom</option>
                        <option value="2">2 Bedrooms</option>
                        <option value="3">3 Bedrooms</option>
                        <option value="4">4+ Bedrooms</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="squareFootage">Approximate Square Footage</label>
                    <input type="number" id="squareFootage" placeholder="800">
                </div>
                
                <div class="form-group">
                    <label for="searchRadius">Search Radius</label>
                    <select id="searchRadius">
                        <option value="0.5">0.5 miles</option>
                        <option value="1">1 mile</option>
                        <option value="2">2 miles</option>
                        <option value="5">5 miles</option>
                    </select>
                </div>
                
                <button class="btn" onclick="searchComparableRents()">🔍 Find Comparable Rents</button>
                
                <div id="marketAnalysisResults" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>Market Analysis Results</h3>
                    <div id="marketAnalysisContent"></div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label for="manualComparables">Manual Comparable Research (Optional)</label>
                    <textarea id="manualComparables" placeholder="If you've found comparable properties manually, enter details here: Property address, rent amount, bedrooms, square footage, amenities..."></textarea>
                </div>
            </div>

            <!-- Legal Research Section -->
            <div id="legal-research" class="section">
                <h2>Legal Research & Precedents</h2>
                <p>Research relevant legal precedents and regulations to strengthen your case.</p>
                
                <div class="form-group">
                    <label for="townWithFRC">Your Town/City</label>
                    <select id="townWithFRC">
                        <option value="">Select your town</option>
                        <option value="bridgeport">Bridgeport</option>
                        <option value="hartford">Hartford</option>
                        <option value="new-haven">New Haven</option>
                        <option value="stamford">Stamford</option>
                        <option value="waterbury">Waterbury</option>
                        <option value="norwalk">Norwalk</option>
                        <option value="danbury">Danbury</option>
                        <option value="west-hartford">West Hartford</option>
                        <option value="greenwich">Greenwich</option>
                        <option value="hamden">Hamden</option>
                        <option value="other">Other (25,000+ residents)</option>
                    </select>
                </div>
                
                <button class="btn" onclick="searchLegalPrecedents()">⚖️ Find Relevant Legal Precedents</button>
                
                <div id="legalResearchResults" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>Relevant Legal Information</h3>
                    <div id="legalResearchContent"></div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label for="additionalLegalInfo">Additional Legal Research</label>
                    <textarea id="additionalLegalInfo" placeholder="Add any additional legal research, case law, or regulations you've found that support your case..."></textarea>
                </div>
            </div>

            <!-- Resources Section -->
            <div id="resources" class="section">
                <h2>Resources & Information</h2>
                
                <div class="alert">
                    <strong>Legal Disclaimer:</strong> This tool provides general information only. For specific legal advice, consult with a qualified attorney.
                </div>
                
                <h3>Fair Rent Commission Process</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Step 1: File Complaint</strong>
                        <p>Submit written complaint to your local Fair Rent Commission within required timeframe.</p>
                    </div>
                    <div class="timeline-item">
                        <strong>Step 2: Investigation</strong>
                        <p>FRC staff reviews complaint and gathers necessary documentation.</p>
                    </div>
                    <div class="timeline-item">
                        <strong>Step 3: Public Hearing</strong>
                        <p>Formal hearing before FRC board of commissioners.</p>
                    </div>
                    <div class="timeline-item">
                        <strong>Step 4: Decision</strong>
                        <p>FRC issues written decision that is binding on both parties.</p>
                    </div>
                </div>
                
                <h3>Important Contacts</h3>
                <div class="document-list">
                    <div class="document-item">
                        <div>
                            <strong>Connecticut Department of Housing</strong>
                            <p>Find your local Fair Rent Commission</p>
                        </div>
                        <div>
                            <a href="https://portal.ct.gov/doh" target="_blank" class="btn">Visit Website</a>
                        </div>
                    </div>
                    <div class="document-item">
                        <div>
                            <strong>Connecticut Legal Aid</strong>
                            <p>Free legal assistance for qualifying tenants</p>
                        </div>
                        <div>
                            <a href="https://ctlawhelp.org" target="_blank" class="btn">Get Help</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let caseData = {};
    let timelineEvents = [];
    let uploadedDocs = {};

    // Phase 1: LocalStorage persistence
    function saveToLocalStorage() {
        const appData = {
            caseData,
            timelineEvents,
            uploadedDocs,
            currentMarketData,
            currentLegalData,
            lastSaved: new Date().toISOString()
        };
        localStorage.setItem('frcCaseData', JSON.stringify(appData));
    }

    function loadFromLocalStorage() {
        const saved = localStorage.getItem('frcCaseData');
        if (saved) {
            const appData = JSON.parse(saved);
            caseData = appData.caseData || {};
            timelineEvents = appData.timelineEvents || [];
            uploadedDocs = appData.uploadedDocs || {};
            currentMarketData = appData.currentMarketData || null;
            currentLegalData = appData.currentLegalData || null;
            
            // Restore form data
            restoreFormData();
            renderTimeline();
            
            // Restore market and legal data displays
            if (currentMarketData) {
                displayMarketAnalysis(currentMarketData);
            }
            if (currentLegalData) {
                displayLegalResearch(currentLegalData);
            }
            
            updateAllAnalysis();
        }
    }

    function restoreFormData() {
        // Restore basic case info
        if (caseData.tenantName) document.getElementById('tenantName').value = caseData.tenantName;
        if (caseData.propertyAddress) document.getElementById('propertyAddress').value = caseData.propertyAddress;
        if (caseData.landlordName) document.getElementById('landlordName').value = caseData.landlordName;
        if (caseData.currentRent) document.getElementById('currentRent').value = caseData.currentRent;
        if (caseData.proposedRent) document.getElementById('proposedRent').value = caseData.proposedRent;
        if (caseData.rentIncreaseDate) document.getElementById('rentIncreaseDate').value = caseData.rentIncreaseDate;
        if (caseData.caseType) document.getElementById('caseType').value = caseData.caseType;
        
        // Restore financial info
        if (caseData.monthlyIncome) document.getElementById('monthlyIncome').value = caseData.monthlyIncome;
        if (caseData.monthlyExpenses) document.getElementById('monthlyExpenses').value = caseData.monthlyExpenses;
        if (caseData.householdSize) document.getElementById('householdSize').value = caseData.householdSize;
        
        // Restore market analysis fields
        if (caseData.propertyType) document.getElementById('propertyType').value = caseData.propertyType;
        if (caseData.bedrooms) document.getElementById('bedrooms').value = caseData.bedrooms;
        if (caseData.squareFootage) document.getElementById('squareFootage').value = caseData.squareFootage;
        if (caseData.searchRadius) document.getElementById('searchRadius').value = caseData.searchRadius;
        if (caseData.manualComparables) document.getElementById('manualComparables').value = caseData.manualComparables;
        
        // Restore legal research fields
        if (caseData.townWithFRC) document.getElementById('townWithFRC').value = caseData.townWithFRC;
        if (caseData.additionalLegalInfo) document.getElementById('additionalLegalInfo').value = caseData.additionalLegalInfo;
        
        // Restore document status
        for (const [docType, uploaded] of Object.entries(uploadedDocs)) {
            if (uploaded) {
                const statusElement = document.getElementById(docType + '-status');
                if (statusElement) {
                    statusElement.textContent = 'Uploaded';
                    statusElement.classList.remove('status-needed');
                    statusElement.classList.add('status-uploaded');
                }
            }
        }
    }

    // Phase 1: Evidence Strength Analyzer
    class EvidenceAnalyzer {
        constructor() {
            this.evidenceTypes = {
                'lease': { weight: 10, required: true, name: 'Current Lease Agreement' },
                'notice': { weight: 10, required: true, name: 'Rent Increase Notice' },
                'payments': { weight: 8, required: true, name: 'Proof of Current Rent Payments' },
                'comparables': { weight: 9, required: false, name: 'Comparable Rent Research' },
                'violations': { weight: 8, required: false, name: 'Building Code Violations' },
                'income': { weight: 7, required: false, name: 'Income Documentation' },
                'communications': { weight: 6, required: false, name: 'Communication Records' }
            };
        }
        
        analyzeEvidenceStrength(uploadedEvidence, caseData) {
            let totalScore = 0;
            let maxPossibleScore = 0;
            let missingRequired = [];
            let recommendations = [];
            
            for (const [type, config] of Object.entries(this.evidenceTypes)) {
                maxPossibleScore += config.weight;
                
                if (uploadedEvidence[type]) {
                    totalScore += config.weight;
                } else {
                    if (config.required) {
                        missingRequired.push(config.name);
                    } else {
                        recommendations.push(this.getRecommendation(type, config.name, caseData));
                    }
                }
            }
            
            return {
                strength: Math.round((totalScore / maxPossibleScore) * 100),
                missingRequired,
                recommendations: recommendations.filter(r => r),
                score: `${totalScore}/${maxPossibleScore}`
            };
        }
        
        getRecommendation(type, name, caseData) {
            const recommendations = {
                'comparables': 'Research similar rental units in your area to prove the increase is above market rate.',
                'violations': 'Document any habitability issues or code violations to strengthen your case.',
                'income': 'Provide income documentation to demonstrate financial hardship.',
                'communications': 'Include all correspondence with your landlord about the rent increase.'
            };
            
            return recommendations[type] ? { type, name, text: recommendations[type] } : null;
        }
    }

    // Phase 1: Financial Hardship Analyzer
    class FinancialHardshipAnalyzer {
        constructor(caseData) {
            this.income = parseFloat(caseData.monthlyIncome) || 0;
            this.currentRent = parseFloat(caseData.currentRent) || 0;
            this.proposedRent = parseFloat(caseData.proposedRent) || 0;
            this.otherExpenses = parseFloat(caseData.monthlyExpenses) || 0;
            this.householdSize = parseInt(caseData.householdSize) || 1;
        }
        
        calculateHardship() {
            if (!this.income || !this.currentRent || !this.proposedRent) {
                return null;
            }
            
            const currentRentBurden = (this.currentRent / this.income) * 100;
            const proposedRentBurden = (this.proposedRent / this.income) * 100;
            const increase = this.proposedRent - this.currentRent;
            const increasePercent = ((this.proposedRent - this.currentRent) / this.currentRent) * 100;
            
            return {
                currentBurden: currentRentBurden.toFixed(1),
                proposedBurden: proposedRentBurden.toFixed(1),
                exceedsAffordable: proposedRentBurden > 30,
                exceedsSeverelyBurdened: proposedRentBurden > 50,
                annualIncrease: increase * 12,
                increasePercent: increasePercent.toFixed(1),
                displacementRisk: this.assessDisplacementRisk(),
                recommendations: this.getRecommendations(proposedRentBurden, increasePercent)
            };
        }
        
        assessDisplacementRisk() {
            const disposableIncome = this.income - this.currentRent - this.otherExpenses;
            const increaseAmount = this.proposedRent - this.currentRent;
            
            if (increaseAmount > disposableIncome) return 'High';
            if (increaseAmount > disposableIncome * 0.7) return 'Medium';
            return 'Low';
        }
        
        getRecommendations(proposedBurden, increasePercent) {
            const recs = [];
            
            if (proposedBurden > 30) {
                recs.push('Rent burden exceeds HUD affordability standards (30% of income)');
            }
            if (proposedBurden > 50) {
                recs.push('Severely rent-burdened - risk of displacement is high');
            }
            if (increasePercent > 10) {
                recs.push('Rent increase percentage is significantly above typical annual increases');
            }
            
            return recs;
        }
    }

    // Phase 2: Market Analysis & Comparable Rent Finder
    class MarketAnalyzer {
        constructor() {
            this.comparableData = null;
        }

        // Simulate rental market data (in real implementation, this would call APIs)
        async searchComparableRents(propertyInfo) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Generate realistic comparable data based on CT rental market
            const baseRent = parseFloat(caseData.currentRent) || 1200;
            const bedrooms = parseInt(propertyInfo.bedrooms) || 1;
            const sqft = parseInt(propertyInfo.squareFootage) || 800;

            // Generate 5-8 comparable properties with realistic variations
            const comparables = [];
            for (let i = 0; i < 6; i++) {
                const variation = (Math.random() - 0.5) * 0.3; // ±15% variation
                const rentPerSqft = (baseRent / sqft) * (1 + variation);
                
                comparables.push({
                    address: this.generateAddress(),
                    rent: Math.round(rentPerSqft * (sqft + (Math.random() - 0.5) * 200)),
                    bedrooms: bedrooms + (Math.random() > 0.7 ? (Math.random() > 0.5 ? 1 : -1) : 0),
                    sqft: sqft + Math.round((Math.random() - 0.5) * 300),
                    distance: (Math.random() * parseFloat(propertyInfo.searchRadius)).toFixed(1),
                    type: propertyInfo.propertyType || 'apartment'
                });
            }

            this.comparableData = {
                searchCriteria: propertyInfo,
                averageRent: Math.round(comparables.reduce((sum, comp) => sum + comp.rent, 0) / comparables.length),
                medianRent: this.calculateMedian(comparables.map(c => c.rent)),
                properties: comparables,
                marketAnalysis: this.generateMarketAnalysis(comparables, baseRent)
            };

            return this.comparableData;
        }

        generateAddress() {
            const streets = ['Oak St', 'Main St', 'Elm Ave', 'Park Dr', 'Church St', 'High St', 'Valley Rd', 'Maple Ave'];
            const numbers = Math.floor(Math.random() * 999) + 1;
            return `${numbers} ${streets[Math.floor(Math.random() * streets.length)]}`;
        }

        calculateMedian(numbers) {
            const sorted = numbers.sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
        }

        generateMarketAnalysis(comparables, currentRent) {
            const avgRent = comparables.reduce((sum, comp) => sum + comp.rent, 0) / comparables.length;
            const proposedRent = parseFloat(caseData.proposedRent) || currentRent * 1.2;
            
            return {
                averageMarketRent: Math.round(avgRent),
                proposedVsMarket: Math.round(((proposedRent - avgRent) / avgRent) * 100),
                currentVsMarket: Math.round(((currentRent - avgRent) / avgRent) * 100),
                recommendation: proposedRent > avgRent * 1.1 ? 'excessive' : 'reasonable'
            };
        }
    }

    // Phase 2: Legal Precedent Database
    class LegalResearcher {
        constructor() {
            this.precedentDatabase = {
                'bridgeport': [
                    { case: 'Smith v. Bridgeport Housing LLC', year: 2023, outcome: 'Tenant Victory', increase: 35, decision: 'Rent increase of 35% deemed excessive without substantial improvements' },
                    { case: 'Johnson v. Park City Apartments', year: 2022, outcome: 'Landlord Victory', increase: 15, decision: '15% increase approved due to rising utility costs and maintenance' }
                ],
                'hartford': [
                    { case: 'Garcia v. Capitol View Properties', year: 2023, outcome: 'Partial Victory', increase: 25, decision: 'Original 25% increase reduced to 12% after hardship consideration' },
                    { case: 'Williams v. Hartford Management', year: 2022, outcome: 'Tenant Victory', increase: 40, decision: 'Excessive increase without proper notice period' }
                ],
                'stamford': [
                    { case: 'Chen v. Stamford Residential', year: 2023, outcome: 'Tenant Victory', increase: 30, decision: 'Market analysis showed proposed rent 20% above comparable properties' },
                    { case: 'Rodriguez v. Downtown Living', year: 2022, outcome: 'Landlord Victory', increase: 18, decision: 'Significant building improvements justified increase' }
                ],
                'general': [
                    { statute: 'Connecticut General Statutes § 7-148c', description: 'Fair Rent Commission authority and procedures' },
                    { statute: 'Connecticut General Statutes § 47a-15a', description: 'Required notice periods for rent increases' },
                    { regulation: 'HUD 30% Rule', description: 'Housing costs should not exceed 30% of household income' }
                ]
            };
        }

        searchPrecedents(town, caseType, increasePercent) {
            const townCases = this.precedentDatabase[town] || [];
            const generalRules = this.precedentDatabase['general'];
            
            // Find similar cases
            const similarCases = townCases.filter(c => 
                Math.abs(c.increase - increasePercent) <= 10
            );

            return {
                similarCases,
                applicableStatutes: generalRules,
                analysis: this.generateLegalAnalysis(similarCases, increasePercent),
                recommendations: this.generateLegalRecommendations(similarCases, increasePercent)
            };
        }

        generateLegalAnalysis(cases, increasePercent) {
            if (cases.length === 0) {
                return "No directly comparable cases found in local precedent database. Focus on statutory requirements and market analysis.";
            }

            const tenantVictories = cases.filter(c => c.outcome.includes('Tenant')).length;
            const successRate = Math.round((tenantVictories / cases.length) * 100);

            return `Analysis of ${cases.length} similar cases shows ${successRate}% tenant success rate for comparable rent increases. ${tenantVictories > cases.length / 2 ? 'This suggests favorable precedent for challenging similar increases.' : 'Mixed precedent suggests need for strong evidence and documentation.'}`;
        }

        generateLegalRecommendations(cases, increasePercent) {
            const recommendations = [];
            
            if (increasePercent > 25) {
                recommendations.push("Focus on 'excessive increase' argument - increases over 25% often face scrutiny");
            }
            
            if (cases.some(c => c.decision.includes('market'))) {
                recommendations.push("Emphasize market analysis - precedent shows commissions value comparable rent data");
            }
            
            if (cases.some(c => c.decision.includes('hardship'))) {
                recommendations.push("Document financial hardship - local precedent shows this influences decisions");
            }

            recommendations.push("Ensure proper notice requirements were followed per Connecticut General Statutes § 47a-15a");
            
            return recommendations;
        }
    }

    // Enhanced Report Generator with Narrative Formatting
    class NarrativeReportGenerator {
        constructor(caseData, timelineEvents, uploadedDocs, marketData, legalData) {
            this.caseData = caseData;
            this.timelineEvents = timelineEvents;
            this.uploadedDocs = uploadedDocs;
            this.marketData = marketData;
            this.legalData = legalData;
        }

        generateExecutiveSummary() {
            const increaseAmount = parseFloat(this.caseData.proposedRent) - parseFloat(this.caseData.currentRent);
            const increasePercent = ((increaseAmount / parseFloat(this.caseData.currentRent)) * 100).toFixed(1);
            
            let summary = `This case involves a ${increasePercent}% rent increase (${increaseAmount > 0 ? '$' + increaseAmount.toLocaleString() : 'amount'} monthly) imposed by ${this.caseData.landlordName || 'the landlord'} on the property at ${this.caseData.propertyAddress || 'the subject property'}. `;

            // Add financial impact
            if (this.caseData.monthlyIncome) {
                const analyzer = new FinancialHardshipAnalyzer(this.caseData);
                const analysis = analyzer.calculateHardship();
                if (analysis) {
                    summary += `This increase would raise the tenant's rent burden from ${analysis.currentBurden}% to ${analysis.proposedBurden}% of household income, `;
                    if (analysis.exceedsAffordable) {
                        summary += `exceeding HUD affordability standards and creating substantial financial hardship. `;
                    } else {
                        summary += `representing a significant financial burden. `;
                    }
                }
            }

            // Add market analysis if available
            if (this.marketData && this.marketData.marketAnalysis) {
                const marketAnalysis = this.marketData.marketAnalysis;
                if (marketAnalysis.proposedVsMarket > 10) {
                    summary += `Market analysis reveals the proposed rent is ${marketAnalysis.proposedVsMarket}% above comparable properties in the area, indicating the increase lacks market justification. `;
                }
            }

            // Add evidence strength
            const evidenceAnalyzer = new EvidenceAnalyzer();
            const evidenceAnalysis = evidenceAnalyzer.analyzeEvidenceStrength(this.uploadedDocs, this.caseData);
            summary += `The case is supported by ${evidenceAnalysis.strength}% evidence completeness, with ${evidenceAnalysis.missingRequired.length === 0 ? 'all required documentation' : 'substantial documentation'} assembled.`;

            return summary;
        }

        generateFinancialNarrative() {
            if (!this.caseData.monthlyIncome || !this.caseData.currentRent || !this.caseData.proposedRent) {
                return "Financial analysis not available - income and rent information required.";
            }

            const analyzer = new FinancialHardshipAnalyzer(this.caseData);
            const analysis = analyzer.calculateHardship();
            
            let narrative = `The tenant currently allocates ${analysis.currentBurden}% of household income toward rent, `;
            
            if (parseFloat(analysis.currentBurden) <= 30) {
                narrative += `which falls within HUD's affordability guidelines. `;
            } else {
                narrative += `which already exceeds HUD's 30% affordability threshold. `;
            }

            narrative += `The proposed increase would raise this burden to ${analysis.proposedBurden}%, `;
            
            if (analysis.exceedsAffordable) {
                narrative += `creating severe financial hardship and violating federal affordability standards. `;
            }

            narrative += `The annual financial impact of $${analysis.annualIncrease.toLocaleString()} represents a ${analysis.increasePercent}% increase in housing costs. `;

            // Add displacement risk analysis
            narrative += `Based on the household's disposable income, this increase creates a ${analysis.displacementRisk.toLowerCase()} risk of displacement, `;
            
            if (analysis.displacementRisk === 'High') {
                narrative += `as the increase exceeds the household's capacity to absorb additional housing costs without sacrificing essential needs.`;
            } else if (analysis.displacementRisk === 'Medium') {
                narrative += `requiring significant lifestyle adjustments to accommodate the higher housing costs.`;
            } else {
                narrative += `though still imposing a meaningful burden on household finances.`;
            }

            return narrative;
        }

        generateMarketNarrative() {
            if (!this.marketData) {
                return "Market analysis not available. Conducting comparable rent research is recommended to strengthen the case.";
            }

            const market = this.marketData.marketAnalysis;
            const comparables = this.marketData.properties;
            
            let narrative = `Market analysis of ${comparables.length} comparable properties within a ${this.marketData.searchCriteria.searchRadius}-mile radius reveals `;
            
            narrative += `an average market rent of $${market.averageMarketRent} for similar properties. `;
            
            if (market.proposedVsMarket > 15) {
                narrative += `The proposed rent of $${this.caseData.proposedRent} exceeds the market average by ${market.proposedVsMarket}%, indicating the increase is substantially above market rates. `;
            } else if (market.proposedVsMarket > 5) {
                narrative += `The proposed rent exceeds market average by ${market.proposedVsMarket}%, suggesting the increase may not be fully supported by market conditions. `;
            } else {
                narrative += `The proposed rent aligns closely with market rates, suggesting the increase reflects current market conditions. `;
            }

            // Add specific comparable examples
            const highestRent = Math.max(...comparables.map(c => c.rent));
            const lowestRent = Math.min(...comparables.map(c => c.rent));
            
            narrative += `Comparable properties range from $${lowestRent} to $${highestRent}, with most properties clustering around the market average. `;
            
            if (parseFloat(this.caseData.proposedRent) > highestRent) {
                narrative += `Notably, the proposed rent exceeds even the highest-priced comparable property, further supporting the claim of an excessive increase.`;
            }

            return narrative;
        }

        generateLegalNarrative() {
            if (!this.legalData) {
                return "Legal precedent research not available. Reviewing similar cases in your jurisdiction is recommended.";
            }

            let narrative = `Legal research reveals `;
            
            if (this.legalData.similarCases.length > 0) {
                const tenantWins = this.legalData.similarCases.filter(c => c.outcome.includes('Tenant')).length;
                const successRate = Math.round((tenantWins / this.legalData.similarCases.length) * 100);
                
                narrative += `${this.legalData.similarCases.length} similar cases in this jurisdiction, with tenants achieving favorable outcomes in ${successRate}% of comparable rent increase disputes. `;
                
                // Add specific case references
                const relevantCase = this.legalData.similarCases.find(c => c.outcome.includes('Tenant'));
                if (relevantCase) {
                    narrative += `In ${relevantCase.case} (${relevantCase.year}), the commission found that ${relevantCase.decision.toLowerCase()}. `;
                }
            } else {
                narrative += `limited directly comparable local precedent, emphasizing the importance of statutory analysis and market-based arguments. `;
            }

            // Add statutory requirements
            narrative += `Under Connecticut General Statutes § 7-148c, Fair Rent Commissions have authority to review rent increases for reasonableness. `;
            narrative += `The analysis considers factors including market conditions, property improvements, landlord costs, and tenant hardship.`;

            return narrative;
        }

        generateRecommendations() {
            const recommendations = [];
            
            // Financial recommendations
            if (this.caseData.monthlyIncome) {
                const analyzer = new FinancialHardshipAnalyzer(this.caseData);
                const analysis = analyzer.calculateHardship();
                if (analysis && analysis.exceedsAffordable) {
                    recommendations.push("Emphasize HUD affordability standard violation (30% rule) as a key argument for rent burden exceeding federal guidelines.");
                }
                if (analysis && analysis.displacementRisk === 'High') {
                    recommendations.push("Highlight displacement risk as public policy concern, as Fair Rent Commissions consider community stability impacts.");
                }
            }

            // Market recommendations
            if (this.marketData && this.marketData.marketAnalysis.proposedVsMarket > 10) {
                recommendations.push("Present market analysis as primary evidence, showing proposed rent significantly exceeds comparable properties.");
            }

            // Legal recommendations
            if (this.legalData && this.legalData.recommendations) {
                recommendations.push(...this.legalData.recommendations);
            }

            // Evidence recommendations
            const evidenceAnalyzer = new EvidenceAnalyzer();
            const evidenceAnalysis = evidenceAnalyzer.analyzeEvidenceStrength(this.uploadedDocs, this.caseData);
            if (evidenceAnalysis.missingRequired.length > 0) {
                recommendations.push(`Complete evidence collection by providing: ${evidenceAnalysis.missingRequired.join(', ')}.`);
            }

            // Timeline recommendations
            if (this.timelineEvents.length > 0) {
                recommendations.push("Utilize timeline of events to demonstrate pattern of landlord behavior or tenant compliance history.");
            }

            return recommendations;
        }
    }

    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected section
        document.getElementById(sectionId).classList.add('active');
        
        // Add active class to clicked button
        event.target.classList.add('active');
        
        // Update progress and analysis
        updateAllAnalysis();
    }

    function saveBasics() {
        try {
            console.log('saveBasics() function called');
            
            // Check if required elements exist
            const requiredFields = ['tenantName', 'propertyAddress', 'landlordName', 'currentRent', 'proposedRent', 'rentIncreaseDate', 'caseType'];
            const missingFields = [];
            
            for (const fieldId of requiredFields) {
                if (!document.getElementById(fieldId)) {
                    missingFields.push(fieldId);
                }
            }
            
            if (missingFields.length > 0) {
                console.error('Missing form fields:', missingFields);
                alert('Error: Some form fields are missing. Please refresh the page and try again.');
                return;
            }
            
            // Save basic case info
            caseData.tenantName = document.getElementById('tenantName').value;
            caseData.propertyAddress = document.getElementById('propertyAddress').value;
            caseData.landlordName = document.getElementById('landlordName').value;
            caseData.currentRent = document.getElementById('currentRent').value;
            caseData.proposedRent = document.getElementById('proposedRent').value;
            caseData.rentIncreaseDate = document.getElementById('rentIncreaseDate').value;
            caseData.caseType = document.getElementById('caseType').value;
            
            // Save financial info (optional fields)
            const monthlyIncomeEl = document.getElementById('monthlyIncome');
            const monthlyExpensesEl = document.getElementById('monthlyExpenses');
            const householdSizeEl = document.getElementById('householdSize');
            
            if (monthlyIncomeEl) caseData.monthlyIncome = monthlyIncomeEl.value;
            if (monthlyExpensesEl) caseData.monthlyExpenses = monthlyExpensesEl.value;
            if (householdSizeEl) caseData.householdSize = householdSizeEl.value;
            
            console.log('Case data saved:', caseData);
            
            // Perform financial hardship analysis
            try {
                performFinancialAnalysis();
            } catch (error) {
                console.error('Error in financial analysis:', error);
            }
            
            // Save to localStorage
            try {
                saveToLocalStorage();
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
            
            alert('Case basics saved successfully!');
            
            try {
                updateAllAnalysis();
            } catch (error) {
                console.error('Error updating analysis:', error);
            }
            
            try {
                showSection('documents'); // Auto-advance to documents
            } catch (error) {
                console.error('Error showing documents section:', error);
            }
            
        } catch (error) {
            console.error('Error in saveBasics():', error);
            alert('An error occurred while saving. Please check the browser console for details and try again.');
        }
    }

    // Test function for debugging
    function testSave() {
        try {
            alert('Test function working! Now checking form fields...');
            
            const tenantName = document.getElementById('tenantName');
            const currentRent = document.getElementById('currentRent');
            
            if (!tenantName) {
                alert('ERROR: tenantName field not found!');
                return;
            }
            
            if (!currentRent) {
                alert('ERROR: currentRent field not found!');
                return;
            }
            
            alert(`Form fields found! Tenant name: "${tenantName.value}" Current rent: "${currentRent.value}"`);
            
            // Try the actual save function
            saveBasics();
            
        } catch (error) {
            alert('Error in test function: ' + error.message);
            console.error('Test function error:', error);
        }
    }

    function performFinancialAnalysis() {
        const analyzer = new FinancialHardshipAnalyzer(caseData);
        const analysis = analyzer.calculateHardship();
        
        if (analysis) {
            const hardshipDiv = document.getElementById('hardshipAnalysis');
            const resultsDiv = document.getElementById('hardshipResults');
            
            resultsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div>
                        <strong>Current Rent Burden:</strong> ${analysis.currentBurden}%<br>
                        <strong>Proposed Rent Burden:</strong> ${analysis.proposedBurden}%<br>
                        <strong>Annual Increase:</strong> $${analysis.annualIncrease.toLocaleString()}
                    </div>
                    <div>
                        <strong>Increase Percentage:</strong> ${analysis.increasePercent}%<br>
                        <strong>Displacement Risk:</strong> ${analysis.displacementRisk}<br>
                        <strong>Exceeds HUD Standard:</strong> ${analysis.exceedsAffordable ? 'Yes' : 'No'}
                    </div>
                </div>
                ${analysis.recommendations.length > 0 ? `
                    <div class="alert">
                        <strong>Financial Impact Analysis:</strong><br>
                        ${analysis.recommendations.map(rec => `• ${rec}`).join('<br>')}
                    </div>
                ` : ''}
            `;
            
            hardshipDiv.style.display = 'block';
        }
    }

    function updateDocStatus(docType) {
        const statusElement = document.getElementById(docType + '-status');
        statusElement.textContent = 'Uploaded';
        statusElement.classList.remove('status-needed');
        statusElement.classList.add('status-uploaded');
        
        uploadedDocs[docType] = true;
        
        // Save to localStorage and update analysis
        saveToLocalStorage();
        updateEvidenceAnalysis();
        updateProgress();
    }

    function updateEvidenceAnalysis() {
        const analyzer = new EvidenceAnalyzer();
        const analysis = analyzer.analyzeEvidenceStrength(uploadedDocs, caseData);
        
        // Update strength bar
        const strengthBar = document.getElementById('evidenceStrengthBar');
        const strengthText = document.getElementById('evidenceStrengthText');
        
        strengthBar.style.width = analysis.strength + '%';
        strengthText.textContent = `Evidence Strength: ${analysis.strength}% (${analysis.score})`;
        
        // Color code the strength bar
        if (analysis.strength >= 80) {
            strengthBar.style.background = 'linear-gradient(45deg, #4caf50, #8bc34a)';
        } else if (analysis.strength >= 60) {
            strengthBar.style.background = 'linear-gradient(45deg, #ff9800, #ffc107)';
        } else {
            strengthBar.style.background = 'linear-gradient(45deg, #f44336, #e91e63)';
        }
        
        // Show missing required documents
        const missingDiv = document.getElementById('missingRequired');
        const missingList = document.getElementById('missingRequiredList');
        
        if (analysis.missingRequired.length > 0) {
            missingList.innerHTML = analysis.missingRequired.map(doc => 
                `<div class="alert" style="background: #ffebee; border-left-color: #c62828; margin: 5px 0;">• ${doc}</div>`
            ).join('');
            missingDiv.style.display = 'block';
        } else {
            missingDiv.style.display = 'none';
        }
        
        // Show recommendations
        const recommendationsList = document.getElementById('recommendationsList');
        if (analysis.recommendations.length > 0) {
            recommendationsList.innerHTML = analysis.recommendations.map(rec => 
                `<div class="alert" style="margin: 5px 0;">
                    <strong>${rec.name}:</strong> ${rec.text}
                </div>`
            ).join('');
        } else {
            recommendationsList.innerHTML = '<div class="alert">Your evidence is complete! Consider gathering additional supporting documentation to strengthen your case further.</div>';
        }
    }

    function updateAllAnalysis() {
        updateProgress();
        updateEvidenceAnalysis();
        if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
            performFinancialAnalysis();
        }
    }

    function addTimelineEvent() {
        const date = document.getElementById('eventDate').value;
        const description = document.getElementById('eventDescription').value;
        
        if (!date || !description) {
            alert('Please fill in both date and description');
            return;
        }
        
        timelineEvents.push({
            date: date,
            description: description
        });
        
        // Sort events by date
        timelineEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        renderTimeline();
        
        // Clear form
        document.getElementById('eventDate').value = '';
        document.getElementById('eventDescription').value = '';
        
        // Save to localStorage
        saveToLocalStorage();
        updateProgress();
    }

    function renderTimeline() {
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';
        
        timelineEvents.forEach((event, index) => {
            const eventElement = document.createElement('div');
            eventElement.className = 'timeline-item';
            eventElement.innerHTML = `
                <strong>${new Date(event.date).toLocaleDateString()}</strong>
                <p>${event.description}</p>
                <button class="btn" onclick="removeTimelineEvent(${index})" style="background: #dc3545; margin-top: 10px;">Remove</button>
            `;
            container.appendChild(eventElement);
        });
    }

    function removeTimelineEvent(index) {
        timelineEvents.splice(index, 1);
        renderTimeline();
        saveToLocalStorage();
        updateProgress();
    }

    function generateComplaint() {
        const summary = document.getElementById('complaintSummary').value;
        const rentIncrease = document.getElementById('rentIncrease').value;
        const whyExcessive = document.getElementById('whyExcessive').value;
        const reliefSought = document.getElementById('reliefSought').value;
        
        if (!summary || !rentIncrease || !whyExcessive || !reliefSought) {
            alert('Please fill in all complaint fields');
            return;
        }

        // Save complaint data
        caseData.complaintSummary = summary;
        caseData.rentIncrease = rentIncrease;
        caseData.whyExcessive = whyExcessive;
        caseData.reliefSought = reliefSought;
        
        // Include financial hardship analysis in complaint if available
        let hardshipSection = '';
        if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
            const analyzer = new FinancialHardshipAnalyzer(caseData);
            const analysis = analyzer.calculateHardship();
            if (analysis) {
                hardshipSection = `
                    <h5>FINANCIAL HARDSHIP ANALYSIS:</h5>
                    <p>Current rent burden: ${analysis.currentBurden}% of household income</p>
                    <p>Proposed rent burden: ${analysis.proposedBurden}% of household income</p>
                    <p>Annual rent increase: $${analysis.annualIncrease.toLocaleString()} (${analysis.increasePercent}% increase)</p>
                    <p>Displacement risk: ${analysis.displacementRisk}</p>
                    ${analysis.exceedsAffordable ? '<p><strong>This rent increase would exceed HUD affordability standards (30% of income).</strong></p>' : ''}
                `;
            }
        }
        
        const complaintText = `
            <h4>FAIR RENT COMMISSION COMPLAINT</h4>
            <p><strong>Tenant:</strong> ${caseData.tenantName || '[Your Name]'}</p>
            <p><strong>Property Address:</strong> ${caseData.propertyAddress || '[Property Address]'}</p>
            <p><strong>Landlord:</strong> ${caseData.landlordName || '[Landlord Name]'}</p>
            <p><strong>Current Rent:</strong> $${caseData.currentRent || '[Current Rent]'}</p>
            <p><strong>Proposed Rent:</strong> $${caseData.proposedRent || '[Proposed Rent]'}</p>
            <p><strong>Increase Date:</strong> ${caseData.rentIncreaseDate || '[Date]'}</p>
            
            <h5>COMPLAINT SUMMARY:</h5>
            <p>${summary}</p>
            
            <h5>RENT INCREASE DETAILS:</h5>
            <p>${rentIncrease}</p>
            
            <h5>WHY THE INCREASE IS EXCESSIVE:</h5>
            <p>${whyExcessive}</p>
            
            ${hardshipSection}
            
            <h5>RELIEF SOUGHT:</h5>
            <p>${reliefSought}</p>
            
            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            <p><strong>Signature:</strong> _________________________</p>
        `;
        
        document.getElementById('complaintText').innerHTML = complaintText;
        document.getElementById('complaintOutput').style.display = 'block';
        
        saveToLocalStorage();
        updateProgress();
        showSection('preparation'); // Auto-advance to preparation
    }

    function printComplaint() {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Fair Rent Commission Complaint</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h4, h5 { color: #333; }
                        p { margin: 10px 0; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('complaintText').innerHTML}
                </body>
            </html>
        `);
        printWindow.print();
    }

    function saveHearingPrep() {
        const openingStatement = document.getElementById('openingStatement').value;
        
        if (openingStatement) {
            caseData.openingStatement = openingStatement;
            saveToLocalStorage();
            alert('Hearing preparation saved successfully!');
            updateProgress();
            showSection('report'); // Auto-advance to report
        } else {
            alert('Please add some content before saving');
        }
    }

    function generateCaseReport() {
        const reportTitle = document.getElementById('reportTitle').value;
        const reportSummary = document.getElementById('reportSummary').value;

        if (!reportTitle || !reportSummary) {
            alert('Please fill in both report title and summary');
            return;
        }

        // Save report data
        caseData.reportTitle = reportTitle;
        caseData.reportSummary = reportSummary;

        // Create enhanced narrative report using new generator
        const narrativeGenerator = new NarrativeReportGenerator(
            caseData, 
            timelineEvents, 
            uploadedDocs, 
            currentMarketData, 
            currentLegalData
        );

        // Generate comprehensive narrative sections
        const executiveSummary = narrativeGenerator.generateExecutiveSummary();
        const financialNarrative = narrativeGenerator.generateFinancialNarrative();
        const marketNarrative = narrativeGenerator.generateMarketNarrative();
        const legalNarrative = narrativeGenerator.generateLegalNarrative();
        const recommendations = narrativeGenerator.generateRecommendations();

        // Create professional narrative report
        const reportText = `
            <h4>${reportTitle}</h4>
            <div style="margin-bottom: 25px;">
                <h5>Executive Summary</h5>
                <p style="line-height: 1.6; text-align: justify;">${executiveSummary}</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h5>Financial Impact Analysis</h5>
                <p style="line-height: 1.6; text-align: justify;">${financialNarrative}</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h5>Market Analysis</h5>
                <p style="line-height: 1.6; text-align: justify;">${marketNarrative}</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h5>Legal Analysis & Precedents</h5>
                <p style="line-height: 1.6; text-align: justify;">${legalNarrative}</p>
            </div>

            ${timelineEvents.length > 0 ? `
                <div style="margin-bottom: 25px;">
                    <h5>Chronology of Events</h5>
                    <p style="line-height: 1.6;">The following timeline documents key events in this case:</p>
                    ${timelineEvents.map(event => `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>${new Date(event.date).toLocaleDateString()}:</strong> ${event.description}
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            ${recommendations.length > 0 ? `
                <div style="margin-bottom: 25px;">
                    <h5>Strategic Recommendations</h5>
                    <p style="line-height: 1.6;">Based on the comprehensive analysis above, the following strategic recommendations are provided:</p>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        ${recommendations.map(rec => `<li style="margin: 8px 0;">${rec}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            <div style="margin-bottom: 25px;">
                <h5>Case Preparation Status</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <p><strong>Evidence Collection:</strong> ${(() => {
                            const evidenceAnalyzer = new EvidenceAnalyzer();
                            const analysis = evidenceAnalyzer.analyzeEvidenceStrength(uploadedDocs, caseData);
                            return analysis.strength + '% complete';
                        })()}</p>
                        <p><strong>Financial Analysis:</strong> ${caseData.monthlyIncome ? 'Complete' : 'Pending'}</p>
                        <p><strong>Market Research:</strong> ${currentMarketData ? 'Complete' : 'Pending'}</p>
                    </div>
                    <div>
                        <p><strong>Legal Research:</strong> ${currentLegalData ? 'Complete' : 'Pending'}</p>
                        <p><strong>Complaint Form:</strong> ${document.getElementById('complaintOutput').style.display === 'block' ? 'Generated' : 'Not Generated'}</p>
                        <p><strong>Hearing Preparation:</strong> ${caseData.openingStatement ? 'Complete' : 'Pending'}</p>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #1976d2;">
                <p style="margin: 0; font-style: italic;">
                    <strong>Note:</strong> This comprehensive analysis integrates financial hardship assessment, 
                    market research, and legal precedent analysis to provide a complete foundation for your 
                    Fair Rent Commission case. All narrative sections are automatically generated based on 
                    your input data and research findings.
                </p>
            </div>
        `;

        document.getElementById('caseReportText').innerHTML = reportText;
        document.getElementById('caseReportOutput').style.display = 'block';
        
        saveToLocalStorage();
        updateProgress();
    }

    function printCaseReport() {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Fair Rent Commission Case Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h4, h5 { color: #333; }
                        p { margin: 10px 0; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('caseReportText').innerHTML}
                </body>
            </html>
        `);
        printWindow.print();
    }

    // Phase 2 Functions
    let marketAnalyzer = new MarketAnalyzer();
    let legalResearcher = new LegalResearcher();
    let currentMarketData = null;
    let currentLegalData = null;

    async function searchComparableRents() {
        const propertyInfo = {
            propertyType: document.getElementById('propertyType').value,
            bedrooms: document.getElementById('bedrooms').value,
            squareFootage: document.getElementById('squareFootage').value,
            searchRadius: document.getElementById('searchRadius').value
        };

        if (!propertyInfo.propertyType || !propertyInfo.bedrooms) {
            alert('Please select property type and number of bedrooms');
            return;
        }

        try {
            // Show loading state
            const button = event.target;
            button.textContent = '🔍 Searching...';
            button.disabled = true;

            const marketData = await marketAnalyzer.searchComparableRents(propertyInfo);
            currentMarketData = marketData;

            displayMarketAnalysis(marketData);
            saveToLocalStorage();

        } catch (error) {
            alert('Error searching comparable rents. Please try again.');
        } finally {
            // Reset button
            const button = document.querySelector('button[onclick="searchComparableRents()"]');
            button.textContent = '🔍 Find Comparable Rents';
            button.disabled = false;
        }
    }

    function displayMarketAnalysis(data) {
        const resultsDiv = document.getElementById('marketAnalysisResults');
        const contentDiv = document.getElementById('marketAnalysisContent');

        const currentRent = parseFloat(caseData.currentRent) || 0;
        const proposedRent = parseFloat(caseData.proposedRent) || 0;

        contentDiv.innerHTML = `
            <div class="alert" style="background: ${data.marketAnalysis.recommendation === 'excessive' ? '#ffebee' : '#e8f5e8'}; margin-bottom: 20px;">
                <strong>Market Analysis Conclusion:</strong> 
                The proposed rent increase appears to be <strong>${data.marketAnalysis.recommendation}</strong> based on comparable properties.
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4>Market Summary</h4>
                    <p><strong>Average Market Rent:</strong> $${data.averageRent}</p>
                    <p><strong>Median Market Rent:</strong> $${data.medianRent}</p>
                    <p><strong>Current Rent vs Market:</strong> ${data.marketAnalysis.currentVsMarket}%</p>
                    <p><strong>Proposed Rent vs Market:</strong> ${data.marketAnalysis.proposedVsMarket}%</p>
                </div>
                <div>
                    <h4>Rent Analysis</h4>
                    <p><strong>Current Rent:</strong> $${currentRent}</p>
                    <p><strong>Proposed Rent:</strong> $${proposedRent}</p>
                    <p><strong>Increase Amount:</strong> $${proposedRent - currentRent}</p>
                    <p><strong>Increase Percentage:</strong> ${((proposedRent - currentRent) / currentRent * 100).toFixed(1)}%</p>
                </div>
            </div>

            <h4>Comparable Properties Found</h4>
            <div style="margin-top: 10px;">
                ${data.properties.map(prop => `
                    <div class="document-item" style="margin: 10px 0;">
                        <div>
                            <strong>${prop.address}</strong>
                            <p>${prop.bedrooms} bed, ${prop.sqft} sqft ${prop.type} - ${prop.distance} miles away</p>
                        </div>
                        <div>
                            <strong>$${prop.rent}/month</strong>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        resultsDiv.style.display = 'block';
    }

    function searchLegalPrecedents() {
        const town = document.getElementById('townWithFRC').value;
        if (!town) {
            alert('Please select your town/city');
            return;
        }

        const increasePercent = caseData.currentRent && caseData.proposedRent ? 
            ((parseFloat(caseData.proposedRent) - parseFloat(caseData.currentRent)) / parseFloat(caseData.currentRent)) * 100 : 20;

        const legalData = legalResearcher.searchPrecedents(town, caseData.caseType, increasePercent);
        currentLegalData = legalData;

        displayLegalResearch(legalData);
        saveToLocalStorage();
    }

    function displayLegalResearch(data) {
        const resultsDiv = document.getElementById('legalResearchResults');
        const contentDiv = document.getElementById('legalResearchContent');

        contentDiv.innerHTML = `
            <div class="alert">
                <strong>Legal Analysis:</strong> ${data.analysis}
            </div>

            ${data.similarCases.length > 0 ? `
                <h4>Similar Cases Found</h4>
                ${data.similarCases.map(case => `
                    <div class="timeline-item" style="margin: 10px 0;">
                        <strong>${case.case} (${case.year})</strong>
                        <p><strong>Outcome:</strong> ${case.outcome}</p>
                        <p><strong>Rent Increase:</strong> ${case.increase}%</p>
                        <p><strong>Decision:</strong> ${case.decision}</p>
                    </div>
                `).join('')}
            ` : ''}

            <h4>Applicable Legal Framework</h4>
            ${data.applicableStatutes.map(statute => `
                <div class="document-item" style="margin: 10px 0;">
                    <div>
                        <strong>${statute.statute || statute.regulation}</strong>
                        <p>${statute.description}</p>
                    </div>
                </div>
            `).join('')}

            ${data.recommendations.length > 0 ? `
                <h4>Strategic Recommendations</h4>
                ${data.recommendations.map(rec => `
                    <div class="alert" style="margin: 5px 0;">• ${rec}</div>
                `).join('')}
            ` : ''}
        `;

        resultsDiv.style.display = 'block';
    }

    function updateProgress() {
        let completedItems = 0;
        let totalItems = 9; // Updated for new sections
        
        // Check if basics are filled (including financial info)
        if (caseData.tenantName && caseData.propertyAddress && caseData.currentRent && caseData.proposedRent) {
            completedItems++;
        }
        
        // Check if required documents are uploaded
        const requiredDocs = ['lease', 'notice', 'payments'];
        const hasRequiredDocs = requiredDocs.every(doc => uploadedDocs[doc]);
        if (hasRequiredDocs) {
            completedItems++;
        }
        
        // Check if timeline has events
        if (timelineEvents.length > 0) {
            completedItems++;
        }
        
        // Check if complaint is generated
        if (document.getElementById('complaintOutput').style.display === 'block') {
            completedItems++;
        }
        
        // Check if hearing prep is done
        if (caseData.openingStatement) {
            completedItems++;
        }

        // Check if market analysis is done
        if (currentMarketData) {
            completedItems++;
        }
        
        // Check if legal research is done
        if (currentLegalData) {
            completedItems++;
        }

        // Check if report is generated
        if (document.getElementById('caseReportOutput').style.display === 'block') {
            completedItems++;
        }
        
        // Resources section is always available
        completedItems++; // Always count resources as complete
        
        const progressPercent = Math.round((completedItems / totalItems) * 100);
        document.getElementById('progressBar').style.width = progressPercent + '%';
        document.getElementById('progressText').textContent = progressPercent + '% Complete';
    }

    // Clear all data function
    function clearAllData() {
        if (confirm('Are you sure you want to clear all case data? This cannot be undone.')) {
            localStorage.removeItem('frcCaseData');
            location.reload();
        }
    }

    // Add real-time saving for form inputs
    function setupAutoSave() {
        const inputs = ['tenantName', 'propertyAddress', 'landlordName', 'currentRent', 'proposedRent', 'rentIncreaseDate', 'caseType', 'monthlyIncome', 'monthlyExpenses', 'householdSize'];
        
        inputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('input', function() {
                    caseData[inputId] = this.value;
                    saveToLocalStorage();
                    
                    // Update financial analysis in real-time if relevant fields change
                    if (['monthlyIncome', 'currentRent', 'proposedRent', 'monthlyExpenses'].includes(inputId)) {
                        if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
                            performFinancialAnalysis();
                        }
                    }
                });
            }
        });

        // Auto-save textarea fields
        const textareas = ['complaintSummary', 'rentIncrease', 'whyExcessive', 'reliefSought', 'openingStatement', 'reportTitle', 'reportSummary', 'manualComparables', 'additionalLegalInfo'];
        textareas.forEach(textareaId => {
            const element = document.getElementById(textareaId);
            if (element) {
                element.addEventListener('input', function() {
                    caseData[textareaId] = this.value;
                    saveToLocalStorage();
                });
            }
        });

        // Auto-save select fields
        const selects = ['propertyType', 'bedrooms', 'searchRadius', 'townWithFRC'];
        selects.forEach(selectId => {
            const element = document.getElementById(selectId);
            if (element) {
                element.addEventListener('change', function() {
                    caseData[selectId] = this.value;
                    saveToLocalStorage();
                });
            }
        });
    }

    // Add a save indicator
    function showSaveIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'saveIndicator';
        indicator.innerHTML = '✓ Data saved automatically';
        indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 10px 15px; border-radius: 5px; z-index: 1000; opacity: 0; transition: opacity 0.3s;';
        document.body.appendChild(indicator);
        
        // Show and hide the indicator
        setTimeout(() => indicator.style.opacity = '1', 100);
        setTimeout(() => indicator.style.opacity = '0', 2000);
        setTimeout(() => document.body.removeChild(indicator), 2500);
    }

    // Override saveToLocalStorage to show indicator
    const originalSaveToLocalStorage = saveToLocalStorage;
    saveToLocalStorage = function() {
        originalSaveToLocalStorage();
        showSaveIndicator();
    };

    // PDF Generation Class
    class PDFGenerator {
        constructor() {
            this.doc = null;
            this.yPosition = 20;
            this.margin = 20;
            this.pageWidth = 210; // A4 width in mm
            this.pageHeight = 297; // A4 height in mm
        }

        initDocument() {
            this.doc = new jsPDF();
            this.yPosition = 20;
        }

        addTitle(title) {
            this.doc.setFontSize(16);
            this.doc.setFont(undefined, 'bold');
            this.doc.text(title, this.margin, this.yPosition);
            this.yPosition += 15;
        }

        addHeading(heading) {
            this.checkPageBreak(15);
            this.doc.setFontSize(12);
            this.doc.setFont(undefined, 'bold');
            this.doc.text(heading, this.margin, this.yPosition);
            this.yPosition += 10;
        }

        addText(text, indent = 0) {
            this.doc.setFontSize(10);
            this.doc.setFont(undefined, 'normal');
            
            const maxWidth = this.pageWidth - (this.margin * 2) - indent;
            const lines = this.doc.splitTextToSize(text, maxWidth);
            
            for (let line of lines) {
                this.checkPageBreak(8);
                this.doc.text(line, this.margin + indent, this.yPosition);
                this.yPosition += 6;
            }
            this.yPosition += 3; // Extra spacing between paragraphs
        }

        addKeyValue(key, value, indent = 0) {
            this.checkPageBreak(8);
            this.doc.setFontSize(10);
            this.doc.setFont(undefined, 'bold');
            this.doc.text(key + ':', this.margin + indent, this.yPosition);
            
            this.doc.setFont(undefined, 'normal');
            const keyWidth = this.doc.getTextWidth(key + ': ');
            const maxWidth = this.pageWidth - (this.margin * 2) - indent - keyWidth;
            const lines = this.doc.splitTextToSize(value, maxWidth);
            
            let isFirstLine = true;
            for (let line of lines) {
                if (!isFirstLine) {
                    this.checkPageBreak(8);
                    this.yPosition += 6;
                }
                this.doc.text(line, this.margin + indent + (isFirstLine ? keyWidth : 0), this.yPosition);
                isFirstLine = false;
            }
            this.yPosition += 8;
        }

        addSeparator() {
            this.checkPageBreak(10);
            this.doc.setDrawColor(200, 200, 200);
            this.doc.line(this.margin, this.yPosition, this.pageWidth - this.margin, this.yPosition);
            this.yPosition += 10;
        }

        checkPageBreak(requiredSpace) {
            if (this.yPosition + requiredSpace > this.pageHeight - 20) {
                this.doc.addPage();
                this.yPosition = 20;
            }
        }

        addSignatureLine() {
            this.checkPageBreak(30);
            this.yPosition += 10;
            this.doc.setFontSize(10);
            this.doc.setFont(undefined, 'normal');
            this.doc.text('Date: _______________', this.margin, this.yPosition);
            this.yPosition += 15;
            this.doc.text('Signature: _________________________________', this.margin, this.yPosition);
        }

        save(filename) {
            this.doc.save(filename);
        }
    }

    function downloadComplaintPDF() {
        try {
            const generator = new PDFGenerator();
            generator.initDocument();

            // Title
            generator.addTitle('FAIR RENT COMMISSION COMPLAINT');
            generator.yPosition += 5;

            // Case Information
            generator.addHeading('CASE INFORMATION');
            generator.addKeyValue('Tenant', caseData.tenantName || '[Your Name]');
            generator.addKeyValue('Property Address', caseData.propertyAddress || '[Property Address]');
            generator.addKeyValue('Landlord', caseData.landlordName || '[Landlord Name]');
            generator.addKeyValue('Current Monthly Rent', '$' + (caseData.currentRent || '[Current Rent]'));
            generator.addKeyValue('Proposed Monthly Rent', '$' + (caseData.proposedRent || '[Proposed Rent]'));
            generator.addKeyValue('Effective Date of Increase', caseData.rentIncreaseDate || '[Date]');

            generator.addSeparator();

            // Complaint Details
            if (caseData.complaintSummary) {
                generator.addHeading('COMPLAINT SUMMARY');
                generator.addText(caseData.complaintSummary);
            }

            if (caseData.rentIncrease) {
                generator.addHeading('RENT INCREASE DETAILS');
                generator.addText(caseData.rentIncrease);
            }

            if (caseData.whyExcessive) {
                generator.addHeading('WHY THE INCREASE IS EXCESSIVE');
                generator.addText(caseData.whyExcessive);
            }

            // Financial Hardship Analysis
            if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
                const analyzer = new FinancialHardshipAnalyzer(caseData);
                const analysis = analyzer.calculateHardship();
                if (analysis) {
                    generator.addHeading('FINANCIAL HARDSHIP ANALYSIS');
                    generator.addKeyValue('Current Rent Burden', analysis.currentBurden + '% of household income');
                    generator.addKeyValue('Proposed Rent Burden', analysis.proposedBurden + '% of household income');
                    generator.addKeyValue('Annual Rent Increase', '$' + analysis.annualIncrease.toLocaleString() + ' (' + analysis.increasePercent + '% increase)');
                    generator.addKeyValue('Displacement Risk', analysis.displacementRisk);
                    
                    if (analysis.exceedsAffordable) {
                        generator.addText('⚠️ This rent increase would exceed HUD affordability standards (30% of income).');
                    }
                }
            }

            if (caseData.reliefSought) {
                generator.addHeading('RELIEF SOUGHT');
                generator.addText(caseData.reliefSought);
            }

            generator.addSeparator();
            generator.addText('Submitted on: ' + new Date().toLocaleDateString());
            generator.addSignatureLine();

            // Generate filename
            const tenantName = caseData.tenantName || 'Tenant';
            const propertyAddress = caseData.propertyAddress || 'Property';
            const cleanName = tenantName.replace(/[^a-zA-Z0-9]/g, '_');
            const cleanAddress = propertyAddress.split(' ')[0] || 'Address';
            const filename = `FRC_Complaint_${cleanName}_${cleanAddress}_${new Date().toISOString().split('T')[0]}.pdf`;

            generator.save(filename);

            // Show success message
            showPDFSuccessMessage('Complaint downloaded successfully!');

        } catch (error) {
            console.error('PDF generation error:', error);
            alert('Error generating PDF. Please try again or use the print option.');
        }
    }

    function downloadCaseReportPDF() {
        try {
            const generator = new PDFGenerator();
            generator.initDocument();

            // Title
            const reportTitle = caseData.reportTitle || 'Fair Rent Commission Case Report';
            generator.addTitle(reportTitle);
            generator.yPosition += 5;

            // Report Summary
            if (caseData.reportSummary) {
                generator.addHeading('EXECUTIVE SUMMARY');
                generator.addText(caseData.reportSummary);
            }

            generator.addSeparator();

            // Case Details
            generator.addHeading('CASE DETAILS');
            generator.addKeyValue('Tenant', caseData.tenantName || '[Your Name]');
            generator.addKeyValue('Property Address', caseData.propertyAddress || '[Property Address]');
            generator.addKeyValue('Landlord', caseData.landlordName || '[Landlord Name]');
            generator.addKeyValue('Current Monthly Rent', '$' + (caseData.currentRent || '[Current Rent]'));
            generator.addKeyValue('Proposed Monthly Rent', '$' + (caseData.proposedRent || '[Proposed Rent]'));
            generator.addKeyValue('Effective Date of Increase', caseData.rentIncreaseDate || '[Date]');
            generator.addKeyValue('Case Type', caseData.caseType || '[Case Type]');

            // Evidence Analysis
            const evidenceAnalyzer = new EvidenceAnalyzer();
            const evidenceAnalysis = evidenceAnalyzer.analyzeEvidenceStrength(uploadedDocs, caseData);
            
            generator.addHeading('EVIDENCE STRENGTH ANALYSIS');
            generator.addKeyValue('Evidence Score', evidenceAnalysis.strength + '% (' + evidenceAnalysis.score + ')');
            
            if (evidenceAnalysis.missingRequired.length > 0) {
                generator.addKeyValue('Missing Required Documents', evidenceAnalysis.missingRequired.join(', '));
            } else {
                generator.addText('✓ All required documents collected');
            }

            // Financial Analysis
            if (caseData.monthlyIncome && caseData.currentRent && caseData.proposedRent) {
                const analyzer = new FinancialHardshipAnalyzer(caseData);
                const analysis = analyzer.calculateHardship();
                if (analysis) {
                    generator.addHeading('FINANCIAL HARDSHIP ANALYSIS');
                    generator.addKeyValue('Current Rent Burden', analysis.currentBurden + '% of income');
                    generator.addKeyValue('Proposed Rent Burden', analysis.proposedBurden + '% of income');
                    generator.addKeyValue('Annual Rent Increase', '$' + analysis.annualIncrease.toLocaleString() + ' (' + analysis.increasePercent + '% increase)');
                    generator.addKeyValue('Displacement Risk', analysis.displacementRisk);
                }
            }

            // Timeline
            if (timelineEvents.length > 0) {
                generator.addHeading('TIMELINE OF EVENTS');
                timelineEvents.forEach(event => {
                    generator.addKeyValue(new Date(event.date).toLocaleDateString(), event.description);
                });
            }

            // Documents
            generator.addHeading('UPLOADED DOCUMENTS');
            if (Object.keys(uploadedDocs).length > 0) {
                Object.keys(uploadedDocs).forEach(doc => {
                    generator.addText('• ' + doc.charAt(0).toUpperCase() + doc.slice(1).replace(/([A-Z])/g, ' $1'));
                });
            } else {
                generator.addText('No documents uploaded');
            }

            // Case Status
            generator.addHeading('CASE PREPARATION STATUS');
            generator.addKeyValue('Complaint Generated', document.getElementById('complaintOutput').style.display === 'block' ? 'Yes' : 'No');
            generator.addKeyValue('Opening Statement Prepared', caseData.openingStatement ? 'Yes' : 'No');

            generator.addSeparator();
            generator.addText('Report generated on: ' + new Date().toLocaleDateString());

            // Generate filename
            const tenantName = caseData.tenantName || 'Tenant';
            const cleanName = tenantName.replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `FRC_Case_Report_${cleanName}_${new Date().toISOString().split('T')[0]}.pdf`;

            generator.save(filename);

            // Show success message
            showPDFSuccessMessage('Case report downloaded successfully!');

        } catch (error) {
            console.error('PDF generation error:', error);
            alert('Error generating PDF. Please try again or use the print option.');
        }
    }

    function showPDFSuccessMessage(message) {
        const indicator = document.createElement('div');
        indicator.innerHTML = `📄 ${message}`;
        indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: bold;';
        document.body.appendChild(indicator);
        
        setTimeout(() => indicator.style.opacity = '0', 3000);
        setTimeout(() => document.body.removeChild(indicator), 3500);
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        loadFromLocalStorage();
        setupAutoSave();
        updateAllAnalysis();
        
        // Add clear data button to sidebar
        const clearButton = document.createElement('button');
        clearButton.textContent = 'Clear All Data';
        clearButton.className = 'btn';
        clearButton.style.cssText = 'background: #dc3545; margin-top: 20px; width: 100%;';
        clearButton.onclick = clearAllData;
        document.querySelector('.sidebar').appendChild(clearButton);
        
        console.log('FRC Case Prep Tool v3.0 loaded with Phase 2 features:');
        console.log('✓ Data persistence with localStorage');
        console.log('✓ Evidence strength analysis');
        console.log('✓ Financial hardship analysis');
        console.log('✓ Auto-save functionality');
        console.log('✓ PDF generation for reports and complaints');
        console.log('✓ Market analysis & comparable rent finder');
        console.log('✓ Legal precedent research database');
        console.log('✓ Enhanced narrative report generation');
        
        // Verify key components are loaded
        console.log('Checking key functions...');
        console.log('saveBasics function exists:', typeof saveBasics === 'function');
        console.log('testSave function exists:', typeof testSave === 'function');
        console.log('caseData object:', caseData);
        console.log('tenantName field exists:', !!document.getElementById('tenantName'));
        console.log('currentRent field exists:', !!document.getElementById('currentRent'));
    });
</script>

</body>
</html>
